<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1" /> <title>TRICK: Linux Auditd审计工具 · Chen's Blog</title> <meta name="description" content="背景"> <link rel="icon" href="http://localhost:4000/assets/favicon.png"> <link rel="apple-touch-icon" href="http://localhost:4000/assets/touch-icon.png"> <link rel="stylesheet" href="http://localhost:4000/assets/core.css"> <link rel="canonical" href="http://localhost:4000/archives/2019-08-20/1"> <link rel="alternate" type="application/atom+xml" title="Chen's Blog" href="http://localhost:4000/feed.xml" /> <link href="/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" media="all" /> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?e4a42a371cc5994ee02b940034c29658"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> </head> <body> <aside class="logo"> <a href="http://localhost:4000/"> <img src="/assets/avatar.jpg" class="logo-avatar"> </a> <span class="logo-prompt code">Back to Index</span> </aside> <article> <h1 class="title">ᴀᴜᴛʜᴏʀ: ᴠᴜʟᴋᴇʏ_ᴄʜᴇɴ</h1> <div class="divider"></div> <center><a href="/about" target="_blank">ᴀʙᴏᴜᴛ</a> | <a href="/links" target="_blank">ʟɪɴᴋs</a> | <a href="/AssistTool" target="_blank">ᴀssɪsᴛ ᴛᴏᴏʟ</a> | <a href="/Binary-Learning" target="_blank">ʙɪɴᴀʀʏ ʟᴇᴀʀɴɪɴɢ</a></center> <div class="divider"></div> </article> <div id="content"> <article> <div class="center"> <h1 class="title">TRICK: Linux Auditd审计工具</h1> <time class="code">August 20, 2019</time> </div> <div class="divider"></div> <h2 id="背景">背景</h2> <p>难题：/home/chen/test/目录下的index.html为首页文件，一直被入侵者恶意篡改</p> <p>需求：想要定位攻击方式以及篡改方式</p> <p>命令：<code class="language-plaintext highlighter-rouge">auditctl</code> （安装：<code class="language-plaintext highlighter-rouge">sudo apt install auditd</code>）</p> <p>参数：</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-w 监控文件路径
-p 监控文件筛选 r(读) w(写) x(执行) a(属性改变)
-k 关键词（用于查询监控日志）
</code></pre></div></div> <p>运行：<code class="language-plaintext highlighter-rouge">sudo auditctl -w /home/chen/test/index.html -p w -k index</code>，等待二次篡改</p> <h2 id="过程">过程</h2> <p>发现被篡改执行：<code class="language-plaintext highlighter-rouge">sudo ausearch -i -k index</code> 查看日志</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>type=SYSCALL msg=audit(08/20/2019 02:22:10.905:509) : arch=x86_64 syscall=rename success=yes exit=0 a0=0x7f5c94011370 a1=0x7f5c94005d90 a2=0x0 a3=0x20 items=5 ppid=1966 pid=17243 auid=chen uid=chen gid=chen euid=chen suid=chen fsuid=chen egid=chen sgid=chen fsgid=chen tty=(none) ses=3 comm=pool exe=/usr/bin/gedit key=index 
</code></pre></div></div> <p>了解该日志的格式：</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>syscall : 相关的系统调用
auid : 审计用户ID
uid 和 gid : 访问文件的用户ID和用户组ID
comm : 用户访问文件的命令
exe : 上面命令的可执行文件路径
</code></pre></div></div> <p>这里的<code class="language-plaintext highlighter-rouge">syscall</code>可以理解为是执行的动作，那么这段日志就非常容易理解了：用户chen使用<strong>gedit</strong> rename了该文件（重命名）</p> <p>那么<code class="language-plaintext highlighter-rouge">syscall</code>是什么代表着编辑文件内容呢？（篡改）</p> <p>测试<code class="language-plaintext highlighter-rouge">gedit</code>打开文件、编辑文件内容、保存文件，有三条日志：</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>type=SYSCALL msg=audit(08/20/2019 02:22:10.897:506) : arch=x86_64 syscall=openat success=no exit=EEXIST(File exists) a0=0xffffff9c a1=0x7f5ca0009800 a2=O_WRONLY|O_CREAT|O_EXCL a3=0x1b6 items=2 ppid=1966 pid=17243 auid=chen uid=chen gid=chen euid=chen suid=chen fsuid=chen egid=chen sgid=chen fsgid=chen tty=(none) ses=3 comm=pool exe=/usr/bin/gedit key=index 
type=SYSCALL msg=audit(08/20/2019 02:22:10.897:507) : arch=x86_64 syscall=openat success=yes exit=17 a0=0xffffff9c a1=0x7f5ca0009800 a2=O_WRONLY|O_CREAT|O_NOFOLLOW a3=0x1b6 items=2 ppid=1966 pid=17243 auid=chen uid=chen gid=chen euid=chen suid=chen fsuid=chen egid=chen sgid=chen fsgid=chen tty=(none) ses=3 comm=pool exe=/usr/bin/gedit key=index 
type=SYSCALL msg=audit(08/20/2019 02:22:10.905:509) : arch=x86_64 syscall=rename success=yes exit=0 a0=0x7f5c94011370 a1=0x7f5c94005d90 a2=0x0 a3=0x20 items=5 ppid=1966 pid=17243 auid=chen uid=chen gid=chen euid=chen suid=chen fsuid=chen egid=chen sgid=chen fsgid=chen tty=(none) ses=3 comm=pool exe=/usr/bin/gedit key=index 
</code></pre></div></div> <p>syscall分别为：<code class="language-plaintext highlighter-rouge">openat</code>、<code class="language-plaintext highlighter-rouge">openat</code>、<code class="language-plaintext highlighter-rouge">rename</code>，但注意到第一个<code class="language-plaintext highlighter-rouge">openat</code>的日志中的<code class="language-plaintext highlighter-rouge">success等于no</code></p> <p>也就是说我们可以理解日志中出现<code class="language-plaintext highlighter-rouge">syscall=openat</code>即有人在修改文件，那么查看日志的命令就可以变成：</p> <p><code class="language-plaintext highlighter-rouge">sudo ausearch -i -k index | grep 'syscall=openat'</code></p> <p><strong>END</strong>：定位到了用户、进程就可以继续跟踪了。</p> </article> <div class="page-navigation code"> <a class="next" href="http://localhost:4000/archives/2019-08-21/1" title="NEXT: 对某攻击队的Webshell进行分析">&lt;&lt;</a> <span> &middot; </span> <a class="home" href="http://localhost:4000/" title="Back to Index">INDEX</a> <span> &middot; </span> <a class="prev" href="http://localhost:4000/archives/2019-08-16/1" title="PREV: RGPerson - 随机身份生成脚本">&gt;&gt;</a> </div> </div> <div class="footer"> <span class="block">&lt;/&gt; Copyright &copy; Chen's Blog (GH0ST.CN) 2016-2021</span> </div> <script src="/fancybox/lib/jquery-1.10.2.min.js"></script> <script type="text/javascript" src="/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script> <script> $(document).ready(function() { $("article img").each(function() { var strA = "<a style='text-decoration: none;' id='imgid' href='" + this.src + "'></a>"; $(this).wrapAll(strA); }); }); $("#imgid").fancybox({ openEffect : 'elastic', closeEffect : 'elastic', }); </script> </body> </html>
