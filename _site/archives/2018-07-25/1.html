<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1" /> <title>我的Web应用安全模糊测试之路 · Chen's Blog</title> <meta name="description" content="前言"> <meta name="keywords" content="前言"> <link rel="icon" href="http://localhost:4000/assets/favicon.png"> <link rel="apple-touch-icon" href="http://localhost:4000/assets/touch-icon.png"> <link rel="stylesheet" href="http://localhost:4000/assets/core.css"> <link rel="canonical" href="http://localhost:4000/archives/2018-07-25/1"> <link rel="alternate" type="application/atom+xml" title="Chen's Blog" href="http://localhost:4000/feed.xml" /> <link href="/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" media="all" /> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?e4a42a371cc5994ee02b940034c29658"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> </head> <body> <aside class="logo"> <a href="http://localhost:4000/"> <img src="/assets/avatar.jpg" class="logo-avatar"> </a> <span class="logo-prompt code">Back to Index</span> </aside> <article> <h1 class="title">EvilChen</h1> <div class="divider"></div> <center> <a href="https://github.com/gh0stkey" target="_blank">Github</a> | <a href="https://twitter.com/VulkeyChen" target="_blank">X (Twitter)</a> | <a href="/about" target="_blank">About</a> | <a href="/friends" target="_blank">Friends</a> </center> <div class="divider"></div> </article> <div id="content"> <article> <div class="center"> <h1 class="title">我的Web应用安全模糊测试之路</h1> <time class="code">July 25, 2018</time> </div> <div class="divider"></div> <h1 id="前言">前言</h1> <p>坏蛋(春秋社区)跟我说要我准备议题的时候，我是懵逼的～仔细想了一下自己这么菜，能讲什么呢？</p> <p>思考了很久最终定了这个标题：《我的Web应用安全模糊测试之路》</p> <p>这篇议题主要围绕我做Web应用安全测试的时候所运用的一些技巧和思路。</p> <p><img src="/images/2018-07-25/0.png" alt="title" /></p> <h1 id="我的web应用安全模糊测试之路">我的Web应用安全模糊测试之路</h1> <h2 id="什么是web应用中的模糊测试">什么是Web应用中的模糊测试？</h2> <p>Web应用是基于什么进行传输的？HTTP协议。</p> <p>模糊测试是什么？Payload随机。</p> <p>Payload放哪里？HTTP请求报文格式是什么？<strong>请求行(请求方式 URI HTTP/1.1)</strong>、<strong>请求头</strong>、<strong>请求报文主体(POST Data)</strong>。</p> <p><strong>模糊测试秘籍-&gt;增(Add) &amp;&amp; 删(Del)</strong></p> <h3 id="被固化的测试思维">被固化的测试思维</h3> <p>我列出一个请求，边看边思考你会怎么测试这个请求呢？</p> <p>HTTP请求报文(Request)：</p> <div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/uc/getInfo</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">gh0st.cn</span>
<span class="na">Origin</span><span class="p">:</span> <span class="s">http://gh0st.cn</span>
<span class="s">...</span>
</code></pre></div></div> <p>HTTP响应主体(Response Content):</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1024"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"realName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"yudan"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"mobilePhone"</span><span class="p">:</span><span class="w"> </span><span class="s2">"13888888888"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"cardNo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"111111111111111111"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <p>看到这想必你已经知道自己要测试的内容是什么了，一般来讲很多人会先注意<code class="language-plaintext highlighter-rouge">Origin</code>这个HTTP请求报文头，看响应的HTTP头：</p> <div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">...
Access-Control-Allow-Origin: http://gh0st.cn
Access-Control-Allow-Crdentials: True
Access-Control-Allow-Methods: OPTION, POST, GET
...
</span></code></pre></div></div> <p>如果我修改Origin的值为<code class="language-plaintext highlighter-rouge">http://qianan.cn</code>，返回的也是<code class="language-plaintext highlighter-rouge">Access-Control-Allow-Origin: http://qianan.cn</code>，那就代表着这里存在CORS跨域资源共享(任意域)的问题，具体在这里就不多说了参考我之前的一篇文章：http://gh0st.cn/archives/2018-03-22/1</p> <p>这里也许会有什么匹配之类的验证，一般的两种绕过方法：</p> <p>1.子域名(<code class="language-plaintext highlighter-rouge">http://{domain}.mst.cn/ -&gt; http://gh0st.cn.mst.cn/</code>)</p> <p>2.域名前缀(<code class="language-plaintext highlighter-rouge">http://{a-z}{domain} -&gt; http://agh0st.cn/</code>)</p> <p>也许到这里部分人的测试已经Over了～那么我还会继续测试下去，如何测？往下看↓</p> <h3 id="模糊测试之增">模糊测试之增</h3> <h4 id="增---入门">增 - 入门</h4> <p>观察响应报文格式：</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1024"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"realName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"yudan"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"mobilePhone"</span><span class="p">:</span><span class="w"> </span><span class="s2">"13888888888"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"cardNo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"111111111111111111"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <p>这里的格式为JSON格式，那么跟JSON有关的漏洞最先想到的是什么？</p> <p>没错，JSONP跨域劫持（想科普下？看这里-&gt; http://gh0st.cn/archives/2018-03-22/1）。</p> <p>JSONP跨域劫持需要具备的条件是回调参数，而这里并没有，没有回调参数，那我就增加一个回调参数，如下是我的一份字典：</p> <p><img src="/images/2018-07-25/1.png" alt="1.png" /></p> <p>使用BurpSuite的Intruder模块，进行枚举测试：</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /uc/getInfo?callback=mstkey HTTP/1.1
GET /uc/getInfo?cb=mstkey HTTP/1.1
GET /uc/getInfo?jsonp=mstkey HTTP/1.1
...
</code></pre></div></div> <p>终于某一条请求得到了我想要的结果：</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">mstkey(</span><span class="p">{</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"1024"</span><span class="p">,</span><span class="nl">"realname"</span><span class="p">:</span><span class="s2">"yudan"</span><span class="p">,</span><span class="nl">"mobilePhone"</span><span class="p">:</span><span class="s2">"13888888888"</span><span class="p">,</span><span class="nl">"cardNo"</span><span class="p">:</span><span class="s2">"111111111111111111"</span><span class="p">}</span><span class="err">)</span><span class="w">
</span></code></pre></div></div> <p>那在这里我就可以构建PoC了：</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script&gt;</span><span class="kd">function</span> <span class="nx">mstkey</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span><span class="nx">alert</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">));}</span><span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"http://gh0st.cn/uc/getInfo?callback=mstkey"</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre></div></div> <h4 id="增---进阶">增 - 进阶</h4> <p>除了上面所说的增加回调参数以外，还可以增加什么呢？</p> <p><img src="/images/2018-07-25/2.png" alt="URL" /></p> <p>增加的参数和值可以<strong>分析网站数据</strong>、<strong>关联网站数据</strong>、<strong>整合自用字典与网站字段结合</strong>。</p> <p>响应报文转换：</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1024"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"realName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"yudan"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"mobilePhone"</span><span class="p">:</span><span class="w"> </span><span class="s2">"13888888888"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"cardNo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"111111111111111111"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <p>转换为HTTP请求参数 <strong>键=值</strong> 格式：</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>id=1024
realName=yudan
mobilePhone=13888888888
cardNo=111111111111111111
</code></pre></div></div> <p>初次之外还有什么？当然是使用自用字典和如上总结的进行整合：</p> <p><img src="/images/2018-07-25/3.png" alt="add" /></p> <p>注意一点，参数都整理好之后，对应的值采用B账号的对应值，因为这样才会有差异，才能进行分析是否存在相关的漏洞，一般加参数会存在<strong>越权</strong>问题～</p> <h4 id="增---深入">增 - 深入</h4> <p>很多小伙伴挖漏洞的时候核心业务挖不动那肯定怼一些边缘业务和一些后台系统了，大多数人应该都遇见过这样的问题，找到了一个后台的地址点进去是管理界面，突然的有js跳转到登录界面去了，但是查看页面代码却能获取到很多的后台接口～</p> <p>很多人会选择登录爆破、未授权接口使用这些常规操作类型去测试，可能测完就会抛掉了，而我之前测试某项目的时候碰见的就是当我在接口后面加上admin=1的时候响应报文返回了这样的头：</p> <div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">Set-Cookie: xxxxxx=xxxxxxx
</span></code></pre></div></div> <p>给我设置了一个Cookie，我使用这个Cookie直接就进入了后台。</p> <p><img src="/images/2018-07-25/4.png" alt="hidden" /></p> <h3 id="模糊测试之删">模糊测试之删</h3> <p>在这里有一处实际场景：</p> <p><img src="/images/2018-07-25/5.png" alt="mail" /></p> <p>其流程是这样的：输入邮箱-&gt;点击修改邮箱-&gt;发送修改链接到该邮箱-&gt;邮箱打开修改链接-&gt;成功修改</p> <p>明显流程就有问题，按照常的流程来说应该先验证原邮箱(手机号)再做修改操作。</p> <p>点击修改邮箱按钮获取到的请求如下：</p> <div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/uc/changeEmail</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">**</span>
<span class="s">...</span>

mail=admin%40gh0st.cn&amp;token=md5(token)
</code></pre></div></div> <p>这里有Token保护，用来防御CSRF的，这里将token置空或者<strong>删除 键=值</strong> 即可绕过，这里是因为token并没有实际的去做校验，也就是”表面安全”。</p> <h3 id="增的组合拳">增的组合拳</h3> <p>在”删”这个环节里说到了删除CSRF的<code class="language-plaintext highlighter-rouge">token</code>绕过的方法，但不久之后厂商进行了修复。。。</p> <p>它成功的让token校验了，这里无法再使用原来的方法了，但是在这里观察请求和响应：</p> <div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/uc/changeEmail</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">**</span>
<span class="s">...</span>

mail=admin%40gh0st.cn&amp;token=md5(token)
</code></pre></div></div> <p>响应主体：</p> <p><img src="/images/2018-07-25/6.png" alt="mail" /></p> <p>这里输入一个错误的或者已经绑定过的会提示输入错误，然后回显请求报文中的POST Data参数mail的值～</p> <p>也就是说在这里也许会存在CSRF + POST XSS，但是因为Token问题没办法利用～我们该怎么办？</p> <p>这里思来想去，只能尝试设想后台的参数接收-&gt;输出代码：</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
    <span class="k">echo</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'mail'</span><span class="p">];</span><span class="c1">//注意这里使用的是$_REQUEST 默认情况下包含了 $_GET，$_POST 和 $_COOKIE 的数组。</span>
<span class="cp">?&gt;</span>
</code></pre></div></div> <p>如果是如上的接收输出，那么在这里，我修改链接为：</p> <p><code class="language-plaintext highlighter-rouge">http://gh0st.cn/uc/changeEmail?mail=admin@gh0st.cn</code></p> <p>神奇的发现页面回显了admin@gh0st.cn到界面上了，但是并不会去走修改邮箱，也就是说这里还是需要POST请求才会走修改邮箱流程，这里我先有了反射XSS的想法，但是奈何过滤了…</p> <p>于是衍生了第二个思路搭配点击劫持～（科普一下？-&gt;http://gh0st.cn/archives/2017-12-20/1）</p> <p>透明化修改邮箱界面，然后获取修改邮箱按钮位置，做一个一模一样的按钮放在修改邮箱按钮之上，诱导用户点击这个按钮实际上是点击了修改邮箱的按钮～</p> <p><img src="/images/2018-07-25/7.png" alt="clickjacking" /></p> <h1 id="结尾">结尾</h1> <p>感谢有你，每一个你，都要活的精彩。</p> </article> <div class="page-navigation code"> <a class="next" href="http://localhost:4000/archives/2018-08-01/1" title="NEXT: GET请求Referer限制绕过总结">&lt;&lt;</a> <span> &middot; </span> <a class="home" href="http://localhost:4000/" title="Back to Index">INDEX</a> <span> &middot; </span> <a class="prev" href="http://localhost:4000/archives/2018-06-20/1" title="PREV: 记一次对某企业的渗透测试实战">&gt;&gt;</a> </div> </div> <div class="footer"> <span class="block">&lt;/&gt; Copyright &copy; Chen's Blog (GH0ST.CN) 2016-2021</span> </div> <script src="/fancybox/lib/jquery-1.10.2.min.js"></script> <script type="text/javascript" src="/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script> <script> $(document).ready(function() { $("article img").each(function() { var strA = "<a style='text-decoration: none;' id='imgid' href='" + this.src + "'></a>"; $(this).wrapAll(strA); }); $(".block").html("&lt;/&gt; Copyright &copy; Chen's Blog (GH0ST.CN) 2016-" + (new Date()).getFullYear()); }); $("#imgid").fancybox({ openEffect : 'elastic', closeEffect : 'elastic', }); </script> </body> </html>
