<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1" /> <title>记一次对某企业的渗透测试实战 · Chen's Blog</title> <meta name="description" content="前言"> <link rel="icon" href="http://localhost:4000/assets/favicon.png"> <link rel="apple-touch-icon" href="http://localhost:4000/assets/touch-icon.png"> <link rel="stylesheet" href="http://localhost:4000/assets/core.css"> <link rel="canonical" href="http://localhost:4000/archives/2018-06-20/1"> <link rel="alternate" type="application/atom+xml" title="Chen's Blog" href="http://localhost:4000/feed.xml" /> <link href="/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" media="all" /> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?e4a42a371cc5994ee02b940034c29658"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> </head> <body> <aside class="logo"> <a href="http://localhost:4000/"> <img src="/assets/avatar.jpg" class="logo-avatar"> </a> <span class="logo-prompt code">Back to Index</span> </aside> <article> <h1 class="title">ᴀᴜᴛʜᴏʀ: ᴠᴜʟᴋᴇʏ_ᴄʜᴇɴ</h1> <div class="divider"></div> <center><a href="/about" target="_blank">ᴀʙᴏᴜᴛ</a> | <a href="/links" target="_blank">ʟɪɴᴋs</a> | <a href="/AssistTool" target="_blank">ᴀssɪsᴛ ᴛᴏᴏʟ</a> | <a href="/Binary-Learning" target="_blank">ʙɪɴᴀʀʏ ʟᴇᴀʀɴɪɴɢ</a></center> <div class="divider"></div> </article> <div id="content"> <article> <div class="center"> <h1 class="title">记一次对某企业的渗透测试实战</h1> <time class="code">June 20, 2018</time> </div> <div class="divider"></div> <h1 id="前言">前言</h1> <p>本文总结一下漫长的渗透测试过程，想尽了各种方法，终于找到了突破口。so没有绝对的安全，所谓的安全性其实都是相对的～</p> <h1 id="信息踩点">信息踩点</h1> <p>在这里其实没办法去做一些有价值的收集，只能踩点，踩坑。</p> <h2 id="信息难点">信息难点：</h2> <h3 id="传输加密">传输加密：</h3> <p>要做渗透的目标是一个APP，根据抓到的请求包发现这个APP是经过某产品加固过的，所以HTTP的POST请求正文部分(Data)是神奇的密文～</p> <h4 id="分析难点">分析难点</h4> <p>分析：</p> <ul> <li>信息踩点其实也是解决难点的过程，在这里我们尝试对APP进行逆向，发现并没有什么东西，因为被加固了。</li> <li>对APP进行功能的整理，逐个功能点进行抓包分析： <ul> <li>请求正文(data)虽然是密文，但是请求的URI还是真正按照对应的功能去请求的（参考URI的命名和功能的相对应性）</li> </ul> </li> </ul> <h4 id="建立设想a">建立设想(A)：</h4> <p>在这里请教了师傅，说可能GET请求参数并没有经过加密，而后台很有可能是这样写的：</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nv">$mstsec</span> <span class="o">=</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'vulkey'</span><span class="p">];</span><span class="c1">//注意这里使用的是$_REQUEST 默认情况下包含了 $_GET，$_POST 和 $_COOKIE 的数组。</span>
<span class="cp">?&gt;</span>
</code></pre></div></div> <ul> <li>一点即通，首先我可以去测试是否是真的这样的后端处理接收。</li> <li>为了满足第一步的验证，我需要想办法找到一个GET请求的包并且有带有GET参数，这样我才能判断规则，不然就是大海捞针。</li> </ul> <h2 id="有价值的东西">有价值的东西</h2> <p>其实对APP做渗透测试，大部分情况下还是对网站做渗透测试。</p> <p>所以在这里抓包获取到的HOST，直接对其进行了前期的常规信息刺探（端口、目录、指纹…）</p> <p>中间件：Tomcat</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-06-20/0x00.png" alt="Tomcat" /></p> <p>目录开放：/fileUpload/</p> <p>端口开放：8001 1444</p> <p>APP三个功能点：个人用户、资金管理、生活栏目</p> <h1 id="渗透开端">渗透开端</h1> <p>一开始粗略的对整个APP进行抓包，然后做一些简单的测试，发现并没有那种明面上的漏洞（SQL注入、XSS等等…），但是获取了这几条URI：</p> <ol> <li>/userCenter/getUser <strong>[获取用户信息URI POST]</strong></li> <li>/userCenter/pay/getSign?userSign= <strong>[获取Sign POST]</strong></li> <li>/userCenter/life/showShop?pId= <strong>[获取商品信息 GET]</strong></li> <li>/userCenter/showQRcode <strong>[获取二维码图片 POST]</strong></li> </ol> <h2 id="不小心日偏">不小心日偏</h2> <p>仔细的对每个功能点进行测试的时候，抓到了一些”逃出加固命运”的明文报文。</p> <ul> <li>发现了S2-005这个历史悠久的Struts2框架远程代码执行问题：</li> </ul> <p>执行了<code class="language-plaintext highlighter-rouge">whoami</code>：</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-06-20/0x01.png" alt="S2-005" /></p> <ul> <li>发现了SQL注入，这里需要做一些简单的绕过(e.g. <code class="language-plaintext highlighter-rouge">AandND 1 like 1</code>)：</li> </ul> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-06-20/0x02.png" alt="SQLi" /></p> <p>然而没看清楚，一下次给日错地方了…很尴尬。</p> <h2 id="关联分析">关联分析</h2> <p>日偏后我分析了一下两者的特征，发现应该出自同一个程序员之手，并且这个程序员很喜欢使用驼峰命名法…</p> <h3 id="验证设想a">验证设想(A)</h3> <p>在这里我尝试根据每个URI功能点生成GET请求参数的dict：</p> <ul> <li> <p>/userCenter/getUser <strong>[获取用户信息URI POST]</strong></p> <p>dict: [uId, userId, uName, userName …]</p> </li> <li> <p>/userCenter/showQRcode <strong>[获取二维码图片 POST]</strong></p> <p>dict: [uId, userId, uName, userName, imagePath, filePath, codePath, fileName …]</p> </li> </ul> <p>生成请求：</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">GET</span> <span class="o">/</span><span class="nx">userCenter</span><span class="o">/</span><span class="nx">getUser</span><span class="o">?</span><span class="nx">uId</span><span class="o">=</span><span class="mi">10001</span>
<span class="nx">GET</span> <span class="o">/</span><span class="nx">userCenter</span><span class="o">/</span><span class="nx">getUser</span><span class="o">?</span><span class="nx">userId</span><span class="o">=</span><span class="mi">10001</span>
<span class="nx">GET</span> <span class="o">/</span><span class="nx">userCenter</span><span class="o">/</span><span class="nx">getUser</span><span class="o">?</span><span class="nx">uName</span><span class="o">=</span><span class="nx">test001</span>
<span class="nx">GET</span> <span class="o">/</span><span class="nx">userCenter</span><span class="o">/</span><span class="nx">getUser</span><span class="o">?</span><span class="nx">userName</span><span class="o">=</span><span class="nx">test001</span>
<span class="o">...</span>
<span class="nx">GET</span> <span class="o">/</span><span class="nx">userCenter</span><span class="o">/</span><span class="nx">showQRcode</span><span class="o">?</span><span class="nx">uId</span><span class="o">=</span><span class="mi">10001</span>
<span class="nx">GET</span> <span class="o">/</span><span class="nx">userCenter</span><span class="o">/</span><span class="nx">showQRcode</span><span class="o">?</span><span class="nx">userId</span><span class="o">=</span><span class="mi">10001</span>
<span class="nx">GET</span> <span class="o">/</span><span class="nx">userCenter</span><span class="o">/</span><span class="nx">showQRcode</span><span class="o">?</span><span class="nx">uName</span><span class="o">=</span><span class="nx">test001</span>
<span class="nx">GET</span> <span class="o">/</span><span class="nx">userCenter</span><span class="o">/</span><span class="nx">showQRcode</span><span class="o">?</span><span class="nx">userName</span><span class="o">=</span><span class="nx">test001</span>
<span class="nx">GET</span> <span class="o">/</span><span class="nx">userCenter</span><span class="o">/</span><span class="nx">showQRcode</span><span class="o">?</span><span class="nx">imagePath</span><span class="o">=../../</span><span class="nx">index</span><span class="o">.</span><span class="k">do</span>
<span class="nx">GET</span> <span class="o">/</span><span class="nx">userCenter</span><span class="o">/</span><span class="nx">showQRcode</span><span class="o">?</span><span class="nx">filePath</span><span class="o">=../../</span><span class="nx">index</span><span class="o">.</span><span class="k">do</span>
<span class="nx">GET</span> <span class="o">/</span><span class="nx">userCenter</span><span class="o">/</span><span class="nx">showQRcode</span><span class="o">?</span><span class="nx">codePath</span><span class="o">=../../</span><span class="nx">index</span><span class="o">.</span><span class="k">do</span>
<span class="nx">GET</span> <span class="o">/</span><span class="nx">userCenter</span><span class="o">/</span><span class="nx">showQRcode</span><span class="o">?</span><span class="nx">fileName</span><span class="o">=../../</span><span class="nx">index</span><span class="o">.</span><span class="k">do</span>
<span class="o">...</span>
</code></pre></div></div> <h4 id="结论">结论</h4> <p>现实残酷，打败了设想。</p> <h3 id="绝处逢生">绝处逢生</h3> <p>就在想放弃的时候，决定打算”垂死挣扎”一下，重新开始”审视”了各个功能模块，眼光又转到了这个二维码地方。（因为二维码的”皮相”，所以很多人都会忽略它）</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-06-20/0x03.png" alt="QRcode" /></p> <p>这里我去解析了二维码的地址：</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-06-20/0x04.png" alt="QRaddress" /></p> <p>失算…失算…，当去访问这个地址的时候，响应报文中会多出这样的头：</p> <div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">...
Set-Cookie: USESSIONPID=xxx;
...

jpg content
</span></code></pre></div></div> <p>这时候我就知道是时候修改<code class="language-plaintext highlighter-rouge">uId</code>了，然而修改了没用，根据多年的经验（吹牛）我认为是<code class="language-plaintext highlighter-rouge">uSign</code>参数起了作用，这时候对<code class="language-plaintext highlighter-rouge">uSign</code>进行删除发现不行，会提示<code class="language-plaintext highlighter-rouge">uSign</code>参数不存在，当我置空这个参数，发现居然成功了又返回了用户的Cookie凭证…好吧，说明这里有一个逻辑问题…</p> <p>到这下去就很简单了，获取管理员权限有上传点，测试使用jhtml的后缀可以直接绕过上传，但是上传上去之后，直接访问就给你download下来了（很多次遇到这种问题…）</p> <p>好吧，管理员也没啥能危害到服务器的东西了…不过回过头再来看看，二维码这个点还没啃完呢，<code class="language-plaintext highlighter-rouge">fileName</code>这个参数还没去测试，fuzzdb了解一下，先怼lfi的字典进去跑（有个坑这里一定要填写完整[uId, uSign]），然后再进行Fuzz：</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-06-20/0x05.png" alt="fuzzdb lfi" /></p> <p>从<strong>intruder模块(BurpSuite)</strong>的测试结果发现这里是可以读取文件的，并且判断这个web服务是root权限运行的因为我修改<code class="language-plaintext highlighter-rouge">fileName</code>参数的值为<code class="language-plaintext highlighter-rouge">../../../etc/shadow</code>时我直接可以获取到文件的内容，从而获取root账号权限的密码：</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-06-20/0x06.png" alt="cat shadow" /></p> <p>(解密不了)，怎么通过这个本地文件读取漏洞拿到shell？我的思路是通过读取tomcat的密码配置文件然后进入tomcat的Web管理部署war包进行getwebshell，但是这里做了一圈的目录猜解，死活没找到tomcat的应用目录…</p> <p>读取<code class="language-plaintext highlighter-rouge">/root/.bash_history</code>啊(这个文件是记录root用户输入过的命令-<strong>老师傅提醒到</strong>)，突然间我茅塞顿开，是啊，一般运维人员会通过命令行进行管理，那么肯定会有目录出现啊。</p> <p>我修改<code class="language-plaintext highlighter-rouge">fileName</code>参数的值为<code class="language-plaintext highlighter-rouge">../../../root/.bash_history</code>，搜索下关键词tomcat就发现了：</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-06-20/0x07.png" alt="tomcat path" /></p> <p>成功的发现了root用户的命令历史并且找到了Tomat的应用安装路径，那么我只需要修改fileName的参数值为<code class="language-plaintext highlighter-rouge">../../../../home/apache-tomcat-7.0.67/conf/tomcat-users.xml</code>，直接就可以读取到Tomcat的管理员账号权限，从而直接通过外部访问的形式进入Tomcat的管理界面进行控制。</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-06-20/0x08.png" alt="tomcat config" /></p> <p>登录进来之后直接到WAR file to deploy功能点，进行war包的部署（在这里使用压缩的方式将网站后门压缩成zip格式然后修改后缀名.zip为.war即可），点击Browser选择war包然后点击Deploy：</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-06-20/0x09.png" alt="war deploy" /></p> <p>这里部署上去之后回到Applications功能点，可以看到部署的情况，点击你的命名链接然后加上你压缩的文件名（这里我的是 /vulkey/vulkey.jsp）使用Webshell管理工具进行管理，看见了我久违的界面，久违的root权限：</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-06-20/0x10.png" alt="shell" /></p> <h1 id="总结">总结</h1> <p>因为后渗透可能会影响正常业务的运行，所以没有继续进行下去，很遗憾，希望下次有机会。 END: 送给大家一句话：心细则挖天下。</p> </article> <div class="page-navigation code"> <a class="next" href="http://localhost:4000/archives/2018-07-25/1" title="NEXT: 我的Web应用安全模糊测试之路">&lt;&lt;</a> <span> &middot; </span> <a class="home" href="http://localhost:4000/" title="Back to Index">INDEX</a> <span> &middot; </span> <a class="prev" href="http://localhost:4000/archives/2018-05-05/1" title="PREV: 密码重置思路-小密圈的一道题">&gt;&gt;</a> </div> </div> <div class="footer"> <span class="block">&lt;/&gt; Copyright &copy; Chen's Blog (GH0ST.CN) 2016-2021</span> </div> <script src="/fancybox/lib/jquery-1.10.2.min.js"></script> <script type="text/javascript" src="/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script> <script> $(document).ready(function() { $("article img").each(function() { var strA = "<a style='text-decoration: none;' id='imgid' href='" + this.src + "'></a>"; $(this).wrapAll(strA); }); }); $("#imgid").fancybox({ openEffect : 'elastic', closeEffect : 'elastic', }); </script> </body> </html>
