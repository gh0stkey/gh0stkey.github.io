<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1" /> <title>打造Mac下APK逆向环境到实战接口XSS挖掘 · Chen's Blog</title> <meta name="description" content="前言"> <link rel="icon" href="http://localhost:4000/assets/favicon.png"> <link rel="apple-touch-icon" href="http://localhost:4000/assets/touch-icon.png"> <link rel="stylesheet" href="http://localhost:4000/assets/core.css"> <link rel="canonical" href="http://localhost:4000/archives/2018-11-18/1"> <link rel="alternate" type="application/atom+xml" title="Chen's Blog" href="http://localhost:4000/feed.xml" /> <link href="/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" media="all" /> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?e4a42a371cc5994ee02b940034c29658"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> </head> <body> <aside class="logo"> <a href="http://localhost:4000/"> <img src="/assets/avatar.jpg" class="logo-avatar"> </a> <span class="logo-prompt code">Back to Index</span> </aside> <article> <h1 class="title">EvilChen</h1> <div class="divider"></div> <center> <a href="https://github.com/gh0stkey" target="_blank">Github</a> | <a href="https://twitter.com/VulkeyChen" target="_blank">X (Twitter)</a> | <a href="/about" target="_blank">About</a> | <a href="/links" target="_blank">Links</a> </center> <div class="divider"></div> </article> <div id="content"> <article> <div class="center"> <h1 class="title">打造Mac下APK逆向环境到实战接口XSS挖掘</h1> <time class="code">November 18, 2018</time> </div> <div class="divider"></div> <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&auto=1&id=1295969255&height=66"></iframe> <h1 id="前言">前言</h1> <p>想尝试逆向APK来发现一些接口和安全问题，但是Mac下没啥好用的APK逆向工具，于是我就参考文章：https://blog.csdn.net/jyygn163/article/details/71731786 的思路在Mac下使用homebrew安装：</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew <span class="nb">install </span>apktool
brew <span class="nb">install </span>dex2jar
</code></pre></div></div> <p>JD-GUI去http://jd.benow.ca/下载，这里我是用的是jar版。</p> <h1 id="过程">过程</h1> <h2 id="自动化编译">自动化编译</h2> <p>手动敲命令太繁琐了，写个shell脚本一键化。</p> <p>在<code class="language-plaintext highlighter-rouge">.bash_profile</code>文件（环境变量）加入这个命令<code class="language-plaintext highlighter-rouge">alias apkdec="/Users/chen/HackBox/Tools/Android\ Decompile/DeApkScript.sh"</code>，这样当终端打开的时候就可以使用<code class="language-plaintext highlighter-rouge">apkdec</code>命令了，而脚本<code class="language-plaintext highlighter-rouge">DeApkScript.sh</code>的内容如下：</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apktool d <span class="nv">$1</span> <span class="o">&amp;&amp;</span> <span class="nb">mv</span> <span class="nv">$1</span> <span class="nv">$1</span>.zip <span class="o">&amp;&amp;</span> unzip <span class="nv">$1</span>.zip <span class="s2">"*.dex"</span> <span class="nt">-d</span> <span class="nv">$1_dex</span>/ <span class="o">&amp;&amp;</span> <span class="nb">cd</span> <span class="nv">$1_dex</span>/ <span class="o">&amp;&amp;</span> d2j-dex2jar <span class="k">*</span>.dex 
</code></pre></div></div> <p>功能实现如下：</p> <ul> <li>apktool获取资源文件</li> <li>将apk文件重命名为zip文件</li> <li>解压zip文件中的.dex文件</li> <li>切换解压目录</li> <li>将dex文件转换成jar文件</li> </ul> <p>这样，最后只需要使用JD-GUI反编译JAR即可看见源码了。</p> <h2 id="实战">实战</h2> <p>运行命令：</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apkdec xxx.apk
</code></pre></div></div> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-11-18/0.png" alt="apkdec" /></p> <p>首先对<code class="language-plaintext highlighter-rouge">classes-dex2jar.jar</code>文件进反编译，但似乎在Mac下JD-GUI支持的不太好，所以我选择使用luyten（Download：https://github.com/deathmarine/Luyten/releases），如下是两张对比图：</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-11-18/1.png" alt="apkdec" /></p> <h2 id="漏洞挖掘">漏洞挖掘</h2> <p>在luyten下使用Command+G快捷键全局搜索，搜索域名寻找接口（因为这个APP需要内部人员才能登录所以从正常的入口是无法找到接口进行漏洞挖掘的）</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-11-18/2.png" alt="search" /></p> <p>寻找了一番看见这样一个接口：</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-11-18/3.png" alt="api" /></p> <p>二话不说访问之，提示：</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"res_code"</span><span class="p">:</span><span class="s2">"-1008003"</span><span class="p">,</span><span class="nl">"res_message"</span><span class="p">:</span><span class="s2">"参数错误"</span><span class="p">,</span><span class="nl">"timeMillis"</span><span class="p">:</span><span class="mi">1542516229723</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <p>不懂Java的我一脸懵，但是天下语言都是互通的，大概的了解了代码的意思（可能理解的不到位，就不说出来误导了），于是找到这样一个函数：</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-11-18/4.png" alt="function" /></p> <p>从我的理解来看这个接口就是有这两个参数<code class="language-plaintext highlighter-rouge">appId、userName</code>，于是加入GET请求参数中请求：</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">Request:</span><span class="w">
</span><span class="err">?appId=</span><span class="mi">123</span><span class="err">&amp;userName=</span><span class="mi">123</span><span class="w">
</span><span class="err">Response:</span><span class="w">
</span><span class="p">{</span><span class="nl">"res_code"</span><span class="p">:</span><span class="s2">"0"</span><span class="p">,</span><span class="nl">"res_message"</span><span class="p">:</span><span class="s2">"成功"</span><span class="p">,</span><span class="nl">"timeMillis"</span><span class="p">:</span><span class="mi">1542516495613</span><span class="p">,</span><span class="nl">"extData"</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span><span class="nl">"data"</span><span class="p">:[{</span><span class="nl">"appId"</span><span class="p">:</span><span class="s2">"123"</span><span class="p">,</span><span class="nl">"permissionTag"</span><span class="p">:[</span><span class="s2">""</span><span class="p">],</span><span class="nl">"extData"</span><span class="p">:</span><span class="kc">null</span><span class="p">}]}</span><span class="w">
</span></code></pre></div></div> <p>其中appId的参数值返回在了页面中，该请求响应报文<code class="language-plaintext highlighter-rouge">Content-Type: text/html</code>，所以尝试构建XSS，运气好，确实也存在XSS问题：</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-11-18/5.png" alt="alert" /></p> <h1 id="总结">总结</h1> <p>学习、不断的学习。</p> </article> <div class="page-navigation code"> <a class="next" href="http://localhost:4000/archives/2018-12-08/1" title="NEXT: iOS URL Schemes与漏洞的碰撞组合">&lt;&lt;</a> <span> &middot; </span> <a class="home" href="http://localhost:4000/" title="Back to Index">INDEX</a> <span> &middot; </span> <a class="prev" href="http://localhost:4000/archives/2018-11-14/1" title="PREV: 一探短文件名">&gt;&gt;</a> </div> </div> <div class="footer"> <span class="block">&lt;/&gt; Copyright &copy; Chen's Blog (GH0ST.CN) 2016-2021</span> </div> <script src="/fancybox/lib/jquery-1.10.2.min.js"></script> <script type="text/javascript" src="/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script> <script> $(document).ready(function() { $("article img").each(function() { var strA = "<a style='text-decoration: none;' id='imgid' href='" + this.src + "'></a>"; $(this).wrapAll(strA); }); $(".block").html("&lt;/&gt; Copyright &copy; Chen's Blog (GH0ST.CN) 2016-" + (new Date()).getFullYear()); }); $("#imgid").fancybox({ openEffect : 'elastic', closeEffect : 'elastic', }); </script> </body> </html>
