<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1" /> <title>iOS URL Schemes与漏洞的碰撞组合 · Chen's Blog</title> <meta name="description" content="前言"> <link rel="icon" href="http://localhost:4000/assets/favicon.png"> <link rel="apple-touch-icon" href="http://localhost:4000/assets/touch-icon.png"> <link rel="stylesheet" href="http://localhost:4000/assets/core.css"> <link rel="canonical" href="http://localhost:4000/archives/2018-12-08/1"> <link rel="alternate" type="application/atom+xml" title="Chen's Blog" href="http://localhost:4000/feed.xml" /> <link href="/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" media="all" /> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?e4a42a371cc5994ee02b940034c29658"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> </head> <body> <aside class="logo"> <a href="http://localhost:4000/"> <img src="/assets/avatar.jpg" class="logo-avatar"> </a> <span class="logo-prompt code">Back to Index</span> </aside> <article> <h1 class="title">ᴀᴜᴛʜᴏʀ: ᴠᴜʟᴋᴇʏ_ᴄʜᴇɴ</h1> <div class="divider"></div> <center><a href="/about" target="_blank">ᴀʙᴏᴜᴛ</a> | <a href="/links" target="_blank">ʟɪɴᴋs</a> | <a href="/AssistTool" target="_blank">ᴀssɪsᴛ ᴛᴏᴏʟ</a> | <a href="/RGPerson" target="_blank">ʀɢᴘᴇʀsᴏɴ</a> | <a href="/Binary-Learning" target="_blank">ʙɪɴᴀʀʏ ʟᴇᴀʀɴɪɴɢ</a></center> <div class="divider"></div> </article> <div id="content"> <article> <div class="center"> <h1 class="title">iOS URL Schemes与漏洞的碰撞组合</h1> <time class="code">December 8, 2018</time> </div> <div class="divider"></div> <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&auto=1&id=460225644&height=66"></iframe> <h1 id="前言">前言</h1> <p>iOS URL Schemes，这个单词对于大多数人来说可能有些陌生，但是类似下面这张图的提示大部分人应该都经常看见：</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-12-08/0.png" alt="wechat" /></p> <p>今天要探究的就是：了解iOS URL Schemes、如何发现iOS URL Schemes、iOS URL Schemes结合漏洞案例。</p> <h1 id="ios-url-schemes">iOS URL Schemes</h1> <h2 id="基本概念">基本概念</h2> <p>抛开iOS从URL Schemes的字面意思理解，就是地址协议（<strong>Scheme一般用来表示协议，比如 http、https、ftp 等</strong>），我们所熟知的HTTP协议的URL格式就是：</p> <p><code class="language-plaintext highlighter-rouge">http(s)://user:pass@host:port/path?query</code></p> <p>举个例子：<code class="language-plaintext highlighter-rouge">http://gh0st.cn/</code>，在浏览器输入这个地址，浏览器是使用HTTP协议向 <strong>gh0st.cn</strong> 请求，请求的资源就是 <strong>/</strong> 。</p> <p>再来看一下iOS URL Schemes的一个例子：<code class="language-plaintext highlighter-rouge">weixin://</code>，你在Safari浏览器(Mobile)输入这个网址就会提示你<code class="language-plaintext highlighter-rouge"> 在"微信"中打开链接吗？</code>，然后由你选择”取消”或”打开”；<strong>和HTTP协议格式的URL访问流程进行对比，iOS URL Schemes 实际上就是启动一个应用的 URL</strong>，其访问流程是这样的：</p> <p><code class="language-plaintext highlighter-rouge">浏览器输入"weixin://" -&gt; iOS识别URL Schemes -&gt;询问是否跳转到微信 -&gt; 确认跳转 -&gt; 从浏览器跳转到微信端</code></p> <p>那么问题就来了，以上所述流程中的”<strong>iOS识别URL Schemes</strong>“，iOS如何识别这段URL Schemes？<strong>iOS官方要求的是APP开发者需要自己定义自己APP的”URL Schemes”，只有APP本身定义(支持)了URL Schemes，iOS才会去识别然后跳转</strong>。</p> <h2 id="定义">定义</h2> <p>一个完整的 URL Schemes 应该分为 Scheme、Action、Parameter、Value 这 4 个部分，中间用冒号 <code class="language-plaintext highlighter-rouge">:</code>、斜线 <code class="language-plaintext highlighter-rouge">/</code>、问号 <code class="language-plaintext highlighter-rouge">?</code>、等号 <code class="language-plaintext highlighter-rouge">=</code> 相连接。</p> <p>举个例子：<code class="language-plaintext highlighter-rouge">mst://jump?url=https://gh0st.cn/&amp;title=test</code>，它对应的4部分就是如下所示：</p> <p>Scheme（头）: <code class="language-plaintext highlighter-rouge">mst</code>、Action（动作）: <code class="language-plaintext highlighter-rouge">jump</code>、Parameter（参数）: <code class="language-plaintext highlighter-rouge">url、title</code>、Value（值）: <code class="language-plaintext highlighter-rouge">https://gh0st.cn、test</code></p> <p>不同的部分之间有符号相连，它们也有一定的规则(和URL部分规则是一样的)：</p> <ul> <li> <p>冒号<code class="language-plaintext highlighter-rouge">:</code>：在<strong>链接头</strong>和<strong>命令</strong>之间；</p> </li> <li>双斜杠 <code class="language-plaintext highlighter-rouge">//</code>：在<strong>链接头和命令</strong>之间，有时会是三斜杠 <code class="language-plaintext highlighter-rouge">///</code>；</li> <li>问号 <code class="language-plaintext highlighter-rouge">?</code>：在<strong>命令和参数</strong>之间；</li> <li>等号 <code class="language-plaintext highlighter-rouge">=</code>：在<strong>参数和值</strong>之间；</li> <li><strong>和符号</strong> <code class="language-plaintext highlighter-rouge">&amp;</code>：在<strong>一组参数和另一组参数</strong>之间。</li> </ul> <h3 id="理解">理解</h3> <p>以上述所举的例子：<code class="language-plaintext highlighter-rouge">mst://jump?url=https://gh0st.cn/&amp;title=test</code>，来简单的说明下这段URL Scheme所产生的效果：</p> <p>1.跳转到”mst”所对应的APP</p> <p>2.在APP中执行jump动作（跳转网站）</p> <p>3.告诉APPjump动作所需的<code class="language-plaintext highlighter-rouge">url</code>和<code class="language-plaintext highlighter-rouge">title</code>参数，对应的值分别为<code class="language-plaintext highlighter-rouge">https://gh0st.cn/</code>和<code class="language-plaintext highlighter-rouge">test</code></p> <p><strong>可以理解为在APP应用中访问<code class="language-plaintext highlighter-rouge">https://gh0st.cn/</code>，网页标题为<code class="language-plaintext highlighter-rouge">test</code>。</strong></p> <h1 id="寻找ios-app的url-schemes">寻找iOS APP的URL Schemes</h1> <p><strong>当你学会了如何寻找APP的URL Schemes，你就算发现了半个漏洞。</strong></p> <h2 id="获取ipa包">获取IPA包</h2> <p>基本的URL Schemes可以在iOS APP中的Info.plist文件中寻找到，而一般你是无法获取到APP的ipa包的，所以需要借助软件获取到这个包。</p> <p>前提是你需要这两台设备：MacBook、iPhone，如果你只拥有一台iPhone的话也有办法去获取（需要Thor APP，具体方法自行寻找）。</p> <p>Mac上先安装Apple Configurator 2，然后你需要在该软件中登录你的Apple账户：</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-12-08/1.png" alt="login" /></p> <p>使用iPhone充电线将手机连接Mac，这时候软件中就会显示已经连接Mac的设备：</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-12-08/2.png" alt="iphone" /></p> <p>假设你需要获取微信的URL Schemes，那么你的手机已经安装过了微信，然后使用该软件进行添加，选中设备点击添加按钮，选择应用：</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-12-08/3.png" alt="add" /></p> <p>搜索微信，选中添加：</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-12-08/4.png" alt="add wechat" /></p> <p>当你下载完成看见如下提示的时候，在Finder中按快捷键<code class="language-plaintext highlighter-rouge">Command+Shift+G</code>，输入<code class="language-plaintext highlighter-rouge">~/资源库/Group Containers/K36BKF7T3D.group.com.apple.configurator/Library/Caches/Assets/TemporaryItems/MobileApps/</code></p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-12-08/5.png" alt="tip" /></p> <p>软件下载的微信ipa文件就存在该文件夹中：</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-12-08/6.png" alt="ipa" /></p> <p>进入文件夹将ipa文件复制到其他地方：</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-12-08/7.png" alt="move" /></p> <p>然后回到Apple Configurator 2的提示，点击停止即可。</p> <h2 id="获取基本url-schemes">获取基本URL Schemes</h2> <p>将IPA包后缀名修改为ZIP，然后解压，进入Payload目录会看见一个.APP后缀名文件，选中文件右击显示包内容：</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-12-08/8.png" alt="view" /></p> <p>找到Info.plist文件并打开，搜索关键词<code class="language-plaintext highlighter-rouge">URLSchemes</code>：</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-12-08/9.png" alt="find" /></p> <p>被<code class="language-plaintext highlighter-rouge">String</code>标签所包含的就是微信的URL Schemes：</p> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;string&gt;</span>wexinVideoAPI<span class="nt">&lt;/string&gt;</span>
<span class="nt">&lt;string&gt;</span>weixin<span class="nt">&lt;/string&gt;</span>
<span class="nt">&lt;string&gt;</span>weixinapp<span class="nt">&lt;/string&gt;</span>
<span class="nt">&lt;string&gt;</span>fb290293790992170<span class="nt">&lt;/string&gt;</span>
<span class="nt">&lt;string&gt;</span>wechat<span class="nt">&lt;/string&gt;</span>
<span class="nt">&lt;string&gt;</span>QQ41C152CF<span class="nt">&lt;/string&gt;</span>
<span class="nt">&lt;string&gt;</span>prefs<span class="nt">&lt;/string&gt;</span>
</code></pre></div></div> <h3 id="寻找完整url-schemes">寻找完整URL Schemes</h3> <p>如上已经了解了如何获取最基本的URL Schemes，但是这远远不够，因为完整的URL Schemes有4部分，而目前只找到了第一部分，仅仅能做到的功能就是启动，而想找到更多的非基本URL Schemes需要其他的方法。有很多方法在这里不一一例举了，只例几个常见的思路供你参考。</p> <h3 id="从手机站点页面获取">从手机站点页面获取</h3> <p>一般网站都会有这些子域名：m\h5\mobile…</p> <p>打开这些子域名，利用Chrome的开发者工具(F12)切换为手机模式视图，这样就能模拟手机去访问了：</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-12-08/10.png" alt="Chrome" /></p> <p>那在这里可以在该页面的HTML代码中寻找URL Schemes（前提是你已经知道了基本的URL Schemes）</p> <p>在这里我从页面的JavaScript代码中发现了很多URL Schemes：</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-12-08/11.png" alt="URL Schemes" /></p> <p>有些还有参数，可以根据命名来猜这些URL Schemes的含义，例如<code class="language-plaintext highlighter-rouge">path: "mst://jump/core/web/jump"</code>，就可以知道这个是做Web跳转的，那跳转到哪个地址是什么参数控制呢？下面也有对应的告诉我们是<code class="language-plaintext highlighter-rouge">url</code>参数去控制，也就组成了这样一个URL Scheme: <code class="language-plaintext highlighter-rouge">mst://jump/core/web/jump?url=https://gh0st.cn</code></p> <h3 id="qrlcode解析地址获取">QRLCode解析地址获取</h3> <p>现在很多网站都支持二维码登录，就比如如下这个网站：</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-12-08/12.png" alt="qrlcode" /></p> <p>保存该二维码进行二维码解析：</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-12-08/13.png" alt="text" /></p> <p>解析得出这是一个URL Scheme，修改json参数url的值为我的网站尝试在浏览器中打开成功的触发了跳转APP，并且在APP中访问了我的网站。</p> <h3 id="逆向app">逆向APP</h3> <p>不仅是iOS，安卓也支持URL Schemes，而一般的定义是一样的，所以你可以基于<code class="language-plaintext highlighter-rouge">获取基本URL Schemes</code>这个步骤将.APP文件的后缀去掉，这时候这个文件就变成了一个文件夹拖到Sublime里面全局搜索”<strong>weixin://</strong>“即可。</p> <p>至于安卓的APK的逆向可以参考我之前的一篇文章&lt; <a href="https://gh0st.cn/archives/2018-11-18/1">打造Mac下APK逆向环境到实战接口XSS挖掘</a> &gt;，可以在源代码中、所有文件内容中搜索URL Schemes。</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-12-08/14.png" alt="search" /></p> <h1 id="漏洞案例">漏洞案例</h1> <h2 id="app内url跳转问题">APP内URL跳转问题</h2> <p>其实严格来讲这不算是漏洞，毕竟利用有限，但又和<strong>一切能产生危害的问题都算漏洞</strong>这句话所冲突，所以在这还是选择列了出来，至于厂商觉不觉得是个安全性问题，还要看他们对“安全风险“的定义。</p> <p>如何发现这类问题？在上文中我提到了如何发现URL Schemes，只要你发现了这种类型的URL Schemes就可以尝试替换地址为你的地址然后使用浏览器打开查看是否能在APP内跳转到你的地址，当然利用方式也很简单，构建一个HTML页面即可，然后将网址发送给“<strong>受害者</strong>”即可：</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script&gt;</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="o">=</span><span class="dl">'</span><span class="s1">URL Schemes</span><span class="dl">'</span><span class="p">;</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div> <h2 id="凭证窃取设计不当">凭证窃取（设计不当）</h2> <p>在做一次漏洞挖掘的时候也碰见了很多次这种问题，大概的描述下就是我找到了能在APP中打开网页的入口方式（例如：二维码扫描、URL Schemes动作），让APP访问到我的地址，这样我就可以直接获取到APP中登录后的凭证信息。</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2018-12-08/15.png" alt="gettoken" /></p> <p>利用方式和URL跳转的方式是一样的；关于这方面漏洞产生原理得出一个可能“<strong>不太严谨的结论</strong>”：<strong>APP在做HTTP请求的时候默认所有访问的都是信任域，所以带上了本身已经登录的凭证去请求了</strong>。</p> <h3 id="结合漏洞扩大攻击面">结合漏洞扩大攻击面</h3> <p>在一次APP的漏洞挖掘中发现了一个JSONP劫持的问题，但是在这里只会对APP用户产生影响，在没有二维码扫描的情况下就需要结合URL Schemes来扩大这个漏洞的影响面，而不是局限于self。</p> <p>利用流程：</p> <p>用户打开https://gh0st.cn/test.html，test.html内容：</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script&gt;</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="o">=</span><span class="dl">'</span><span class="s1">mst://jump?url=https://gh0st.cn/jsonp.html</span><span class="dl">'</span><span class="p">;</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div> <p>用户点开之后启动<code class="language-plaintext highlighter-rouge">mst应用</code>执行<code class="language-plaintext highlighter-rouge">jump动作</code>，跳转到https://gh0st.cn/jsonp.html，jsonp.html内容：</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script&gt;</span><span class="kd">function</span> <span class="nx">test</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span> <span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span> <span class="p">}</span><span class="nt">&lt;/script&gt;</span> <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"JSONP URL"</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre></div></div> <h2 id="url-schemes劫持">URL Schemes劫持</h2> <p>这个漏洞是15年在乌云爆出来的，漏洞编号为：wooyun-2015-0103233，大家可以自行去查看。</p> <p>这个问题说白了是一个流程上的缺陷，苹果官方没有限制APP定义的URL Schemes名字，导致其他APP也可以定义“支付宝”的URL Schems名字；又因为iOS系统判定URL Schemes优先级顺序与 Bundle ID 有关（一个 Bundle ID 对应一个应用），如果有人精心伪造 Bundle ID，iOS 就会调用恶意 App 的 URL Schemes 去接收相应的 URL Schemes 请求，这就导致了可以被劫持。</p> <h1 id="结尾">结尾</h1> <p>还有很多思路等着我们去探寻，此文仅做思路启发。</p> <p><strong>Reference:</strong></p> <blockquote> <p>https://sspai.com/post/31500</p> <p>https://sspai.com/post/44591</p> <p>WooyunBugID:wooyun-2015-0103233</p> </blockquote> </article> <div class="page-navigation code"> <a class="next" href="http://localhost:4000/archives/2019-01-23/1" title="NEXT: 我为何在博客模板留后门">&lt;&lt;</a> <span> &middot; </span> <a class="home" href="http://localhost:4000/" title="Back to Index">INDEX</a> <span> &middot; </span> <a class="prev" href="http://localhost:4000/archives/2018-11-18/1" title="PREV: 打造Mac下APK逆向环境到实战接口XSS挖掘">&gt;&gt;</a> </div> </div> <div class="footer"> <span class="block">&lt;/&gt; Copyright &copy; Chen's Blog (GH0ST.CN) 2016-2021</span> </div> <script src="/fancybox/lib/jquery-1.10.2.min.js"></script> <script type="text/javascript" src="/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script> <script> $(document).ready(function() { $("article img").each(function() { var strA = "<a style='text-decoration: none;' id='imgid' href='" + this.src + "'></a>"; $(this).wrapAll(strA); }); }); $("#imgid").fancybox({ openEffect : 'elastic', closeEffect : 'elastic', }); </script> </body> </html>
